var assert = require('assert')
var canonicaljson = require('canonicaljson')
var bracery = require('../index')
var ParseTree = bracery.ParseTree

var initJson = { hello: "[yo|hi]",
		 world: ["world", "planet", "kids", "#hello#xxx#hello##hello#zzz"] }

var chomskyJson = {"cfg":{"#hello#":{"opts":[{"rhs":[{"name":"3","rank":9,"type":"nonterm"}],"weight":1}],"type":"sym"},"1":{"opts":[{"rhs":[{"name":"~hello","rank":7,"type":"nonterm"},{"name":"8","rank":4,"type":"nonterm"}],"weight":1}],"type":"start"},"2":{"opts":[{"rhs":[{"text":"world","type":"term"}],"weight":2.5E-1},{"rhs":[{"text":"planet","type":"term"}],"weight":2.5E-1},{"rhs":[{"text":"kids","type":"term"}],"weight":2.5E-1},{"rhs":[{"name":"#hello#","rank":6,"type":"nonterm"},{"name":"6","rank":3,"type":"nonterm"}],"weight":2.5E-1}],"type":"alt"},"3":{"opts":[{"rhs":[{"text":"yo","type":"term"}],"weight":5.0E-1},{"rhs":[{"text":"hi","type":"term"}],"weight":5.0E-1}],"type":"alt"},"4":{"opts":[{"rhs":[{"name":"#hello#","rank":6,"type":"nonterm"},{"text":"zzz","type":"term"}],"weight":1}],"type":"elim"},"5":{"opts":[{"rhs":[{"name":"#hello#","rank":6,"type":"nonterm"},{"name":"4","rank":1,"type":"nonterm"}],"weight":1}],"type":"elim"},"6":{"opts":[{"rhs":[{"text":"xxx","type":"term"},{"name":"5","rank":2,"type":"nonterm"}],"weight":1}],"type":"elim"},"7":{"opts":[{"rhs":[{"text":"yo","type":"term"}],"weight":5.0E-1},{"rhs":[{"text":"hi","type":"term"}],"weight":5.0E-1}],"type":"alt"},"8":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~world","rank":5,"type":"nonterm"}],"weight":1}],"type":"elim"},"~hello":{"opts":[{"rhs":[{"name":"7","rank":10,"type":"nonterm"}],"weight":1}],"type":"sym"},"~world":{"opts":[{"rhs":[{"name":"2","rank":8,"type":"nonterm"}],"weight":1}],"type":"sym"}},"cyclic":null,"empties":[],"rank":{"#hello#":6,"1":0,"2":8,"3":9,"4":1,"5":2,"6":3,"7":10,"8":4,"~hello":7,"~world":5},"ranked":[{"opts":[{"rhs":[{"name":"~hello","rank":7,"type":"nonterm"},{"name":"8","rank":4,"type":"nonterm"}],"weight":1}],"type":"start"},{"opts":[{"rhs":[{"name":"#hello#","rank":6,"type":"nonterm"},{"text":"zzz","type":"term"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"name":"#hello#","rank":6,"type":"nonterm"},{"name":"4","rank":1,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"text":"xxx","type":"term"},{"name":"5","rank":2,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~world","rank":5,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"name":"2","rank":8,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"3","rank":9,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"7","rank":10,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"text":"world","type":"term"}],"weight":2.5E-1},{"rhs":[{"text":"planet","type":"term"}],"weight":2.5E-1},{"rhs":[{"text":"kids","type":"term"}],"weight":2.5E-1},{"rhs":[{"name":"#hello#","rank":6,"type":"nonterm"},{"name":"6","rank":3,"type":"nonterm"}],"weight":2.5E-1}],"type":"alt"},{"opts":[{"rhs":[{"text":"yo","type":"term"}],"weight":5.0E-1},{"rhs":[{"text":"hi","type":"term"}],"weight":5.0E-1}],"type":"alt"},{"opts":[{"rhs":[{"text":"yo","type":"term"}],"weight":5.0E-1},{"rhs":[{"text":"hi","type":"term"}],"weight":5.0E-1}],"type":"alt"}],"sort":["1","4","5","6","8","~world","#hello#","~hello","2","3","7"],"start":"1"}

var cyclicJson = {a:["~b ~c","~b~d"],b:["~e~f"],c:["~f ~g"],d:"",e:["","~a"],f:["[|x]"],g:"x"}
var chomskyCyclicJson = {"cfg":{"1":{"opts":[{"rhs":[{"name":"~a","rank":9,"type":"nonterm"}],"weight":1}],"type":"start"},"2":{"opts":[{"rhs":[{"name":"~b","rank":3,"type":"nonterm"},{"name":"6","rank":11,"type":"nonterm"}],"weight":5.0E-1},{"rhs":[{"name":"~b","rank":3,"type":"nonterm"},{"name":"~d","rank":12,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},"3":{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"text":"x","type":"term"}],"weight":5.0E-1}],"type":"alt"},"4":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~g","rank":2,"type":"nonterm"}],"weight":1}],"type":"elim"},"5":{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"name":"~a","rank":9,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},"6":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~c","rank":1,"type":"nonterm"}],"weight":1}],"type":"elim"},"~a":{"opts":[{"rhs":[{"name":"2","rank":10,"type":"nonterm"}],"weight":1}],"type":"sym"},"~b":{"opts":[{"rhs":[{"name":"~e","rank":5,"type":"nonterm"},{"name":"~f","rank":6,"type":"nonterm"}],"weight":1}],"type":"sym"},"~c":{"opts":[{"rhs":[{"name":"~f","rank":6,"type":"nonterm"},{"name":"4","rank":4,"type":"nonterm"}],"weight":1}],"type":"sym"},"~d":{"opts":[],"type":"sym"},"~e":{"opts":[{"rhs":[{"name":"5","rank":7,"type":"nonterm"}],"weight":1}],"type":"sym"},"~f":{"opts":[{"rhs":[{"name":"3","rank":8,"type":"nonterm"}],"weight":1}],"type":"sym"},"~g":{"opts":[{"rhs":[{"text":"x","type":"term"}],"weight":1}],"type":"sym"}},"cyclic":null,"empties":["3","5","~b","~e","~f"],"rank":{"1":0,"2":10,"3":8,"4":4,"5":7,"6":11,"~a":9,"~b":3,"~c":1,"~d":12,"~e":5,"~f":6,"~g":2},"ranked":[{"opts":[{"rhs":[{"name":"~a","rank":9,"type":"nonterm"}],"weight":1}],"type":"start"},{"opts":[{"rhs":[{"name":"~f","rank":6,"type":"nonterm"},{"name":"4","rank":4,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"text":"x","type":"term"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"~e","rank":5,"type":"nonterm"},{"name":"~f","rank":6,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~g","rank":2,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"name":"5","rank":7,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"3","rank":8,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"name":"~a","rank":9,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"text":"x","type":"term"}],"weight":5.0E-1}],"type":"alt"},{"opts":[{"rhs":[{"name":"2","rank":10,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"~b","rank":3,"type":"nonterm"},{"name":"6","rank":11,"type":"nonterm"}],"weight":5.0E-1},{"rhs":[{"name":"~b","rank":3,"type":"nonterm"},{"name":"~d","rank":12,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~c","rank":1,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[],"type":"sym"}],"sort":["1","~c","~g","~b","4","~e","~f","5","3","~a","2","6","~d"],"start":"1"}

var topoJson = {a:["~b ~c","~b ~d"],b:["~e ~f"],c:["~f ~g"],d:"",e:["","~a"],f:["[|x]"],g:"x"}
var chomskyTopoJson = {"cfg":{"1":{"opts":[{"rhs":[{"name":"~a","rank":13,"type":"nonterm"}],"weight":1}],"type":"start"},"2":{"opts":[{"rhs":[{"name":"~b","rank":6,"type":"nonterm"},{"name":"7","rank":1,"type":"nonterm"}],"weight":5.0E-1},{"rhs":[{"name":"~b","rank":6,"type":"nonterm"},{"name":"8","rank":2,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},"3":{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"text":"x","type":"term"}],"weight":5.0E-1}],"type":"alt"},"4":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~g","rank":4,"type":"nonterm"}],"weight":1}],"type":"elim"},"5":{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"name":"~a","rank":13,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},"6":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~f","rank":5,"type":"nonterm"}],"weight":1}],"type":"elim"},"7":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~c","rank":3,"type":"nonterm"}],"weight":1}],"type":"elim"},"8":{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~d","rank":8,"type":"nonterm"}],"weight":1}],"type":"elim"},"~a":{"opts":[{"rhs":[{"name":"2","rank":14,"type":"nonterm"}],"weight":1}],"type":"sym"},"~b":{"opts":[{"rhs":[{"name":"~e","rank":7,"type":"nonterm"},{"name":"6","rank":11,"type":"nonterm"}],"weight":1}],"type":"sym"},"~c":{"opts":[{"rhs":[{"name":"~f","rank":5,"type":"nonterm"},{"name":"4","rank":9,"type":"nonterm"}],"weight":1}],"type":"sym"},"~d":{"opts":[],"type":"sym"},"~e":{"opts":[{"rhs":[{"name":"5","rank":12,"type":"nonterm"}],"weight":1}],"type":"sym"},"~f":{"opts":[{"rhs":[{"name":"3","rank":10,"type":"nonterm"}],"weight":1}],"type":"sym"},"~g":{"opts":[{"rhs":[{"text":"x","type":"term"}],"weight":1}],"type":"sym"}},"cyclic":null,"empties":["3","5","~e","~f"],"rank":{"1":0,"2":14,"3":10,"4":9,"5":12,"6":11,"7":1,"8":2,"~a":13,"~b":6,"~c":3,"~d":8,"~e":7,"~f":5,"~g":4},"ranked":[{"opts":[{"rhs":[{"name":"~a","rank":13,"type":"nonterm"}],"weight":1}],"type":"start"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~c","rank":3,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~d","rank":8,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[{"name":"~f","rank":5,"type":"nonterm"},{"name":"4","rank":9,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"text":"x","type":"term"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"3","rank":10,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"~e","rank":7,"type":"nonterm"},{"name":"6","rank":11,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"5","rank":12,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[],"type":"sym"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~g","rank":4,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"text":"x","type":"term"}],"weight":5.0E-1}],"type":"alt"},{"opts":[{"rhs":[{"text":" ","type":"term"},{"name":"~f","rank":5,"type":"nonterm"}],"weight":1}],"type":"elim"},{"opts":[{"rhs":[],"weight":5.0E-1},{"rhs":[{"name":"~a","rank":13,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"},{"opts":[{"rhs":[{"name":"2","rank":14,"type":"nonterm"}],"weight":1}],"type":"sym"},{"opts":[{"rhs":[{"name":"~b","rank":6,"type":"nonterm"},{"name":"7","rank":1,"type":"nonterm"}],"weight":5.0E-1},{"rhs":[{"name":"~b","rank":6,"type":"nonterm"},{"name":"8","rank":2,"type":"nonterm"}],"weight":5.0E-1}],"type":"alt"}],"sort":["1","7","8","~c","~g","~f","~b","~e","~d","4","3","6","5","~a","2"],"start":"1"}


var b = new bracery.Bracery (initJson)
describe('Chomsky normal form', function() {
  it('should convert a test grammar into Chomsky normal form', function (done) {
    var json = bracery.Chomsky.makeChomskyNormalCFG ({ get: b._getSymbol.bind(b),
                                                       root: '~hello ~world' })
    assert.equal (canonicaljson.stringify(json), canonicaljson.stringify(chomskyJson))
    done()
  })

  it('should find a null cycle', function (done) {
    var b2 = new bracery.Bracery (cyclicJson)
    var json2 = bracery.Chomsky.makeChomskyNormalCFG ({ get: b2._getSymbol.bind(b2),
                                                        root: '~a' })
    assert.equal (canonicaljson.stringify(json2), canonicaljson.stringify(chomskyCyclicJson))
    done()
  })

  it('should toposort', function (done) {
    var b3 = new bracery.Bracery (topoJson)
    var json3 = bracery.Chomsky.makeChomskyNormalCFG ({ get: b3._getSymbol.bind(b3),
                                                        root: '~a' })
    assert.equal (canonicaljson.stringify(json3), canonicaljson.stringify(chomskyTopoJson))
    done()
  })

})
