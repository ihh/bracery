(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){"use strict";var helpers=require("./helpers");var ValidatorResult=helpers.ValidatorResult;var SchemaError=helpers.SchemaError;var attribute={};attribute.ignoreProperties={id:true,default:true,description:true,title:true,exclusiveMinimum:true,exclusiveMaximum:true,additionalItems:true,$schema:true,$ref:true,extends:true};var validators=attribute.validators={};validators.type=function validateType(instance,schema,options,ctx){if(instance===undefined){return null}var result=new ValidatorResult(instance,schema,options,ctx);var types=Array.isArray(schema.type)?schema.type:[schema.type];if(!types.some(this.testType.bind(this,instance,schema,options,ctx))){var list=types.map(function(v){return v.id&&"<"+v.id+">"||v+""});result.addError({name:"type",argument:list,message:"is not of a type(s) "+list})}return result};function testSchemaNoThrow(instance,options,ctx,callback,schema){var throwError=options.throwError;options.throwError=false;var res=this.validateSchema(instance,schema,options,ctx);options.throwError=throwError;if(!res.valid&&callback instanceof Function){callback(res)}return res.valid}validators.anyOf=function validateAnyOf(instance,schema,options,ctx){if(instance===undefined){return null}var result=new ValidatorResult(instance,schema,options,ctx);var inner=new ValidatorResult(instance,schema,options,ctx);if(!Array.isArray(schema.anyOf)){throw new SchemaError("anyOf must be an array")}if(!schema.anyOf.some(testSchemaNoThrow.bind(this,instance,options,ctx,function(res){inner.importErrors(res)}))){var list=schema.anyOf.map(function(v,i){return v.id&&"<"+v.id+">"||v.title&&JSON.stringify(v.title)||v["$ref"]&&"<"+v["$ref"]+">"||"[subschema "+i+"]"});if(options.nestedErrors){result.importErrors(inner)}result.addError({name:"anyOf",argument:list,message:"is not any of "+list.join(",")})}return result};validators.allOf=function validateAllOf(instance,schema,options,ctx){if(instance===undefined){return null}if(!Array.isArray(schema.allOf)){throw new SchemaError("allOf must be an array")}var result=new ValidatorResult(instance,schema,options,ctx);var self=this;schema.allOf.forEach(function(v,i){var valid=self.validateSchema(instance,v,options,ctx);if(!valid.valid){var msg=v.id&&"<"+v.id+">"||v.title&&JSON.stringify(v.title)||v["$ref"]&&"<"+v["$ref"]+">"||"[subschema "+i+"]";result.addError({name:"allOf",argument:{id:msg,length:valid.errors.length,valid:valid},message:"does not match allOf schema "+msg+" with "+valid.errors.length+" error[s]:"});result.importErrors(valid)}});return result};validators.oneOf=function validateOneOf(instance,schema,options,ctx){if(instance===undefined){return null}if(!Array.isArray(schema.oneOf)){throw new SchemaError("oneOf must be an array")}var result=new ValidatorResult(instance,schema,options,ctx);var inner=new ValidatorResult(instance,schema,options,ctx);var count=schema.oneOf.filter(testSchemaNoThrow.bind(this,instance,options,ctx,function(res){inner.importErrors(res)})).length;var list=schema.oneOf.map(function(v,i){return v.id&&"<"+v.id+">"||v.title&&JSON.stringify(v.title)||v["$ref"]&&"<"+v["$ref"]+">"||"[subschema "+i+"]"});if(count!==1){if(options.nestedErrors){result.importErrors(inner)}result.addError({name:"oneOf",argument:list,message:"is not exactly one from "+list.join(",")})}return result};validators.properties=function validateProperties(instance,schema,options,ctx){if(!this.types.object(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var properties=schema.properties||{};for(var property in properties){if(typeof options.preValidateProperty=="function"){options.preValidateProperty(instance,property,properties[property],options,ctx)}var prop=Object.hasOwnProperty.call(instance,property)?instance[property]:undefined;var res=this.validateSchema(prop,properties[property],options,ctx.makeChild(properties[property],property));if(res.instance!==result.instance[property])result.instance[property]=res.instance;result.importErrors(res)}return result};function testAdditionalProperty(instance,schema,options,ctx,property,result){if(!this.types.object(instance))return;if(schema.properties&&schema.properties[property]!==undefined){return}if(schema.additionalProperties===false){result.addError({name:"additionalProperties",argument:property,message:"additionalProperty "+JSON.stringify(property)+" exists in instance when not allowed"})}else{var additionalProperties=schema.additionalProperties||{};if(typeof options.preValidateProperty=="function"){options.preValidateProperty(instance,property,additionalProperties,options,ctx)}var res=this.validateSchema(instance[property],additionalProperties,options,ctx.makeChild(additionalProperties,property));if(res.instance!==result.instance[property])result.instance[property]=res.instance;result.importErrors(res)}}validators.patternProperties=function validatePatternProperties(instance,schema,options,ctx){if(!this.types.object(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var patternProperties=schema.patternProperties||{};for(var property in instance){var test=true;for(var pattern in patternProperties){var expr=new RegExp(pattern);if(!expr.test(property)){continue}test=false;if(typeof options.preValidateProperty=="function"){options.preValidateProperty(instance,property,patternProperties[pattern],options,ctx)}var res=this.validateSchema(instance[property],patternProperties[pattern],options,ctx.makeChild(patternProperties[pattern],property));if(res.instance!==result.instance[property])result.instance[property]=res.instance;result.importErrors(res)}if(test){testAdditionalProperty.call(this,instance,schema,options,ctx,property,result)}}return result};validators.additionalProperties=function validateAdditionalProperties(instance,schema,options,ctx){if(!this.types.object(instance))return;if(schema.patternProperties){return null}var result=new ValidatorResult(instance,schema,options,ctx);for(var property in instance){testAdditionalProperty.call(this,instance,schema,options,ctx,property,result)}return result};validators.minProperties=function validateMinProperties(instance,schema,options,ctx){if(!this.types.object(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var keys=Object.keys(instance);if(!(keys.length>=schema.minProperties)){result.addError({name:"minProperties",argument:schema.minProperties,message:"does not meet minimum property length of "+schema.minProperties})}return result};validators.maxProperties=function validateMaxProperties(instance,schema,options,ctx){if(!this.types.object(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var keys=Object.keys(instance);if(!(keys.length<=schema.maxProperties)){result.addError({name:"maxProperties",argument:schema.maxProperties,message:"does not meet maximum property length of "+schema.maxProperties})}return result};validators.items=function validateItems(instance,schema,options,ctx){var self=this;if(!this.types.array(instance))return;if(!schema.items)return;var result=new ValidatorResult(instance,schema,options,ctx);instance.every(function(value,i){var items=Array.isArray(schema.items)?schema.items[i]||schema.additionalItems:schema.items;if(items===undefined){return true}if(items===false){result.addError({name:"items",message:"additionalItems not permitted"});return false}var res=self.validateSchema(value,items,options,ctx.makeChild(items,i));if(res.instance!==result.instance[i])result.instance[i]=res.instance;result.importErrors(res);return true});return result};validators.minimum=function validateMinimum(instance,schema,options,ctx){if(!this.types.number(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var valid=true;if(schema.exclusiveMinimum&&schema.exclusiveMinimum===true){valid=instance>schema.minimum}else{valid=instance>=schema.minimum}if(!valid){result.addError({name:"minimum",argument:schema.minimum,message:"must have a minimum value of "+schema.minimum})}return result};validators.maximum=function validateMaximum(instance,schema,options,ctx){if(!this.types.number(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var valid;if(schema.exclusiveMaximum&&schema.exclusiveMaximum===true){valid=instance<schema.maximum}else{valid=instance<=schema.maximum}if(!valid){result.addError({name:"maximum",argument:schema.maximum,message:"must have a maximum value of "+schema.maximum})}return result};var validateMultipleOfOrDivisbleBy=function validateMultipleOfOrDivisbleBy(instance,schema,options,ctx,validationType,errorMessage){if(!this.types.number(instance))return;var validationArgument=schema[validationType];if(validationArgument==0){throw new SchemaError(validationType+" cannot be zero")}var result=new ValidatorResult(instance,schema,options,ctx);var instanceDecimals=helpers.getDecimalPlaces(instance);var divisorDecimals=helpers.getDecimalPlaces(validationArgument);var maxDecimals=Math.max(instanceDecimals,divisorDecimals);var multiplier=Math.pow(10,maxDecimals);if(Math.round(instance*multiplier)%Math.round(validationArgument*multiplier)!==0){result.addError({name:validationType,argument:validationArgument,message:errorMessage+JSON.stringify(validationArgument)})}return result};validators.multipleOf=function validateMultipleOf(instance,schema,options,ctx){return validateMultipleOfOrDivisbleBy.call(this,instance,schema,options,ctx,"multipleOf","is not a multiple of (divisible by) ")};validators.divisibleBy=function validateDivisibleBy(instance,schema,options,ctx){return validateMultipleOfOrDivisbleBy.call(this,instance,schema,options,ctx,"divisibleBy","is not divisible by (multiple of) ")};validators.required=function validateRequired(instance,schema,options,ctx){var result=new ValidatorResult(instance,schema,options,ctx);if(instance===undefined&&schema.required===true){result.addError({name:"required",message:"is required"})}else if(this.types.object(instance)&&Array.isArray(schema.required)){schema.required.forEach(function(n){if(instance[n]===undefined){result.addError({name:"required",argument:n,message:"requires property "+JSON.stringify(n)})}})}return result};validators.pattern=function validatePattern(instance,schema,options,ctx){if(!this.types.string(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);if(!instance.match(schema.pattern)){result.addError({name:"pattern",argument:schema.pattern,message:"does not match pattern "+JSON.stringify(schema.pattern)})}return result};validators.format=function validateFormat(instance,schema,options,ctx){if(instance===undefined)return;var result=new ValidatorResult(instance,schema,options,ctx);if(!result.disableFormat&&!helpers.isFormat(instance,schema.format,this)){result.addError({name:"format",argument:schema.format,message:"does not conform to the "+JSON.stringify(schema.format)+" format"})}return result};validators.minLength=function validateMinLength(instance,schema,options,ctx){if(!this.types.string(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var hsp=instance.match(/[\uDC00-\uDFFF]/g);var length=instance.length-(hsp?hsp.length:0);if(!(length>=schema.minLength)){result.addError({name:"minLength",argument:schema.minLength,message:"does not meet minimum length of "+schema.minLength})}return result};validators.maxLength=function validateMaxLength(instance,schema,options,ctx){if(!this.types.string(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);var hsp=instance.match(/[\uDC00-\uDFFF]/g);var length=instance.length-(hsp?hsp.length:0);if(!(length<=schema.maxLength)){result.addError({name:"maxLength",argument:schema.maxLength,message:"does not meet maximum length of "+schema.maxLength})}return result};validators.minItems=function validateMinItems(instance,schema,options,ctx){if(!this.types.array(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);if(!(instance.length>=schema.minItems)){result.addError({name:"minItems",argument:schema.minItems,message:"does not meet minimum length of "+schema.minItems})}return result};validators.maxItems=function validateMaxItems(instance,schema,options,ctx){if(!this.types.array(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);if(!(instance.length<=schema.maxItems)){result.addError({name:"maxItems",argument:schema.maxItems,message:"does not meet maximum length of "+schema.maxItems})}return result};validators.uniqueItems=function validateUniqueItems(instance,schema,options,ctx){if(!this.types.array(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);function testArrays(v,i,a){for(var j=i+1;j<a.length;j++)if(helpers.deepCompareStrict(v,a[j])){return false}return true}if(!instance.every(testArrays)){result.addError({name:"uniqueItems",message:"contains duplicate item"})}return result};function testArrays(v,i,a){var j,len=a.length;for(j=i+1,len;j<len;j++){if(helpers.deepCompareStrict(v,a[j])){return false}}return true}validators.uniqueItems=function validateUniqueItems(instance,schema,options,ctx){if(!this.types.array(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);if(!instance.every(testArrays)){result.addError({name:"uniqueItems",message:"contains duplicate item"})}return result};validators.dependencies=function validateDependencies(instance,schema,options,ctx){if(!this.types.object(instance))return;var result=new ValidatorResult(instance,schema,options,ctx);for(var property in schema.dependencies){if(instance[property]===undefined){continue}var dep=schema.dependencies[property];var childContext=ctx.makeChild(dep,property);if(typeof dep=="string"){dep=[dep]}if(Array.isArray(dep)){dep.forEach(function(prop){if(instance[prop]===undefined){result.addError({name:"dependencies",argument:childContext.propertyPath,message:"property "+prop+" not found, required by "+childContext.propertyPath})}})}else{var res=this.validateSchema(instance,dep,options,childContext);if(result.instance!==res.instance)result.instance=res.instance;if(res&&res.errors.length){result.addError({name:"dependencies",argument:childContext.propertyPath,message:"does not meet dependency required by "+childContext.propertyPath});result.importErrors(res)}}}return result};validators["enum"]=function validateEnum(instance,schema,options,ctx){if(instance===undefined){return null}if(!Array.isArray(schema["enum"])){throw new SchemaError("enum expects an array",schema)}var result=new ValidatorResult(instance,schema,options,ctx);if(!schema["enum"].some(helpers.deepCompareStrict.bind(null,instance))){result.addError({name:"enum",argument:schema["enum"],message:"is not one of enum values: "+schema["enum"].map(String).join(",")})}return result};validators["const"]=function validateEnum(instance,schema,options,ctx){if(instance===undefined){return null}var result=new ValidatorResult(instance,schema,options,ctx);if(!helpers.deepCompareStrict(schema["const"],instance)){result.addError({name:"const",argument:schema["const"],message:"does not exactly match expected constant: "+schema["const"]})}return result};validators.not=validators.disallow=function validateNot(instance,schema,options,ctx){var self=this;if(instance===undefined)return null;var result=new ValidatorResult(instance,schema,options,ctx);var notTypes=schema.not||schema.disallow;if(!notTypes)return null;if(!Array.isArray(notTypes))notTypes=[notTypes];notTypes.forEach(function(type){if(self.testType(instance,schema,options,ctx,type)){var schemaId=type&&type.id&&"<"+type.id+">"||type;result.addError({name:"not",argument:schemaId,message:"is of prohibited type "+schemaId})}});return result};module.exports=attribute},{"./helpers":2}],2:[function(require,module,exports){"use strict";var uri=require("url");var ValidationError=exports.ValidationError=function ValidationError(message,instance,schema,propertyPath,name,argument){if(propertyPath){this.property=propertyPath}if(message){this.message=message}if(schema){if(schema.id){this.schema=schema.id}else{this.schema=schema}}if(instance){this.instance=instance}this.name=name;this.argument=argument;this.stack=this.toString()};ValidationError.prototype.toString=function toString(){return this.property+" "+this.message};var ValidatorResult=exports.ValidatorResult=function ValidatorResult(instance,schema,options,ctx){this.instance=instance;this.schema=schema;this.propertyPath=ctx.propertyPath;this.errors=[];this.throwError=options&&options.throwError;this.disableFormat=options&&options.disableFormat===true};ValidatorResult.prototype.addError=function addError(detail){var err;if(typeof detail=="string"){err=new ValidationError(detail,this.instance,this.schema,this.propertyPath)}else{if(!detail)throw new Error("Missing error detail");if(!detail.message)throw new Error("Missing error message");if(!detail.name)throw new Error("Missing validator type");err=new ValidationError(detail.message,this.instance,this.schema,this.propertyPath,detail.name,detail.argument)}if(this.throwError){throw err}this.errors.push(err);return err};ValidatorResult.prototype.importErrors=function importErrors(res){if(typeof res=="string"||res&&res.validatorType){this.addError(res)}else if(res&&res.errors){Array.prototype.push.apply(this.errors,res.errors)}};function stringizer(v,i){return i+": "+v.toString()+"\n"}ValidatorResult.prototype.toString=function toString(res){return this.errors.map(stringizer).join("")};Object.defineProperty(ValidatorResult.prototype,"valid",{get:function(){return!this.errors.length}});var SchemaError=exports.SchemaError=function SchemaError(msg,schema){this.message=msg;this.schema=schema;Error.call(this,msg);Error.captureStackTrace(this,SchemaError)};SchemaError.prototype=Object.create(Error.prototype,{constructor:{value:SchemaError,enumerable:false},name:{value:"SchemaError",enumerable:false}});var SchemaContext=exports.SchemaContext=function SchemaContext(schema,options,propertyPath,base,schemas){this.schema=schema;this.options=options;this.propertyPath=propertyPath;this.base=base;this.schemas=schemas};SchemaContext.prototype.resolve=function resolve(target){return uri.resolve(this.base,target)};SchemaContext.prototype.makeChild=function makeChild(schema,propertyName){var propertyPath=propertyName===undefined?this.propertyPath:this.propertyPath+makeSuffix(propertyName);var base=uri.resolve(this.base,schema.id||"");var ctx=new SchemaContext(schema,this.options,propertyPath,base,Object.create(this.schemas));if(schema.id&&!ctx.schemas[base]){ctx.schemas[base]=schema}return ctx};var FORMAT_REGEXPS=exports.FORMAT_REGEXPS={"date-time":/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])[tT ](2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])(\.\d+)?([zZ]|[+-]([0-5][0-9]):(60|[0-5][0-9]))$/,date:/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])$/,time:/^(2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])$/,email:/^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/,"ip-address":/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,ipv6:/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,uri:/^[a-zA-Z][a-zA-Z0-9+-.]*:[^\s]*$/,color:/^(#?([0-9A-Fa-f]{3}){1,2}\b|aqua|black|blue|fuchsia|gray|green|lime|maroon|navy|olive|orange|purple|red|silver|teal|white|yellow|(rgb\(\s*\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\b\s*,\s*\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\b\s*,\s*\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\b\s*\))|(rgb\(\s*(\d?\d%|100%)+\s*,\s*(\d?\d%|100%)+\s*,\s*(\d?\d%|100%)+\s*\)))$/,hostname:/^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\.?$/,"host-name":/^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\.?$/,alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"utc-millisec":function(input){return typeof input==="string"&&parseFloat(input)===parseInt(input,10)&&!isNaN(input)},regex:function(input){var result=true;try{new RegExp(input)}catch(e){result=false}return result},style:/\s*(.+?):\s*([^;]+);?/g,phone:/^\+(?:[0-9] ?){6,14}[0-9]$/};FORMAT_REGEXPS.regexp=FORMAT_REGEXPS.regex;FORMAT_REGEXPS.pattern=FORMAT_REGEXPS.regex;FORMAT_REGEXPS.ipv4=FORMAT_REGEXPS["ip-address"];exports.isFormat=function isFormat(input,format,validator){if(typeof input==="string"&&FORMAT_REGEXPS[format]!==undefined){if(FORMAT_REGEXPS[format]instanceof RegExp){return FORMAT_REGEXPS[format].test(input)}if(typeof FORMAT_REGEXPS[format]==="function"){return FORMAT_REGEXPS[format](input)}}else if(validator&&validator.customFormats&&typeof validator.customFormats[format]==="function"){return validator.customFormats[format](input)}return true};var makeSuffix=exports.makeSuffix=function makeSuffix(key){key=key.toString();if(!key.match(/[.\s\[\]]/)&&!key.match(/^[\d]/)){return"."+key}if(key.match(/^\d+$/)){return"["+key+"]"}return"["+JSON.stringify(key)+"]"};exports.deepCompareStrict=function deepCompareStrict(a,b){if(typeof a!==typeof b){return false}if(a instanceof Array){if(!(b instanceof Array)){return false}if(a.length!==b.length){return false}return a.every(function(v,i){return deepCompareStrict(a[i],b[i])})}if(typeof a==="object"){if(!a||!b){return a===b}var aKeys=Object.keys(a);var bKeys=Object.keys(b);if(aKeys.length!==bKeys.length){return false}return aKeys.every(function(v){return deepCompareStrict(a[v],b[v])})}return a===b};function deepMerger(target,dst,e,i){if(typeof e==="object"){dst[i]=deepMerge(target[i],e)}else{if(target.indexOf(e)===-1){dst.push(e)}}}function copyist(src,dst,key){dst[key]=src[key]}function copyistWithDeepMerge(target,src,dst,key){if(typeof src[key]!=="object"||!src[key]){dst[key]=src[key]}else{if(!target[key]){dst[key]=src[key]}else{dst[key]=deepMerge(target[key],src[key])}}}function deepMerge(target,src){var array=Array.isArray(src);var dst=array&&[]||{};if(array){target=target||[];dst=dst.concat(target);src.forEach(deepMerger.bind(null,target,dst))}else{if(target&&typeof target==="object"){Object.keys(target).forEach(copyist.bind(null,target,dst))}Object.keys(src).forEach(copyistWithDeepMerge.bind(null,target,src,dst))}return dst}module.exports.deepMerge=deepMerge;exports.objectGetPath=function objectGetPath(o,s){var parts=s.split("/").slice(1);var k;while(typeof(k=parts.shift())=="string"){var n=decodeURIComponent(k.replace(/~0/,"~").replace(/~1/g,"/"));if(!(n in o))return;o=o[n]}return o};function pathEncoder(v){return"/"+encodeURIComponent(v).replace(/~/g,"%7E")}exports.encodePath=function encodePointer(a){return a.map(pathEncoder).join("")};exports.getDecimalPlaces=function getDecimalPlaces(number){var decimalPlaces=0;if(isNaN(number))return decimalPlaces;if(typeof number!=="number"){number=Number(number)}var parts=number.toString().split("e");if(parts.length===2){if(parts[1][0]!=="-"){return decimalPlaces}else{decimalPlaces=Number(parts[1].slice(1))}}var decimalParts=parts[0].split(".");if(decimalParts.length===2){decimalPlaces+=decimalParts[1].length}return decimalPlaces}},{url:10}],3:[function(require,module,exports){"use strict";var Validator=module.exports.Validator=require("./validator");module.exports.ValidatorResult=require("./helpers").ValidatorResult;module.exports.ValidationError=require("./helpers").ValidationError;module.exports.SchemaError=require("./helpers").SchemaError;module.exports.SchemaScanResult=require("./scan").SchemaScanResult;module.exports.scan=require("./scan").scan;module.exports.validate=function(instance,schema,options){var v=new Validator;return v.validate(instance,schema,options)}},{"./helpers":2,"./scan":4,"./validator":5}],4:[function(require,module,exports){var urilib=require("url");var helpers=require("./helpers");module.exports.SchemaScanResult=SchemaScanResult;function SchemaScanResult(found,ref){this.id=found;this.ref=ref}module.exports.scan=function scan(base,schema){function scanSchema(baseuri,schema){if(!schema||typeof schema!="object")return;if(schema.$ref){var resolvedUri=urilib.resolve(baseuri,schema.$ref);ref[resolvedUri]=ref[resolvedUri]?ref[resolvedUri]+1:0;return}var ourBase=schema.id?urilib.resolve(baseuri,schema.id):baseuri;if(ourBase){if(ourBase.indexOf("#")<0)ourBase+="#";if(found[ourBase]){if(!helpers.deepCompareStrict(found[ourBase],schema)){throw new Error("Schema <"+schema+"> already exists with different definition")}return found[ourBase]}found[ourBase]=schema;if(ourBase[ourBase.length-1]=="#"){found[ourBase.substring(0,ourBase.length-1)]=schema}}scanArray(ourBase+"/items",schema.items instanceof Array?schema.items:[schema.items]);scanArray(ourBase+"/extends",schema.extends instanceof Array?schema.extends:[schema.extends]);scanSchema(ourBase+"/additionalItems",schema.additionalItems);scanObject(ourBase+"/properties",schema.properties);scanSchema(ourBase+"/additionalProperties",schema.additionalProperties);scanObject(ourBase+"/definitions",schema.definitions);scanObject(ourBase+"/patternProperties",schema.patternProperties);scanObject(ourBase+"/dependencies",schema.dependencies);scanArray(ourBase+"/disallow",schema.disallow);scanArray(ourBase+"/allOf",schema.allOf);scanArray(ourBase+"/anyOf",schema.anyOf);scanArray(ourBase+"/oneOf",schema.oneOf);scanSchema(ourBase+"/not",schema.not)}function scanArray(baseuri,schemas){if(!(schemas instanceof Array))return;for(var i=0;i<schemas.length;i++){scanSchema(baseuri+"/"+i,schemas[i])}}function scanObject(baseuri,schemas){if(!schemas||typeof schemas!="object")return;for(var p in schemas){scanSchema(baseuri+"/"+p,schemas[p])}}var found={};var ref={};var schemaUri=base;scanSchema(base,schema);return new SchemaScanResult(found,ref)}},{"./helpers":2,url:10}],5:[function(require,module,exports){"use strict";var urilib=require("url");var attribute=require("./attribute");var helpers=require("./helpers");var scanSchema=require("./scan").scan;var ValidatorResult=helpers.ValidatorResult;var SchemaError=helpers.SchemaError;var SchemaContext=helpers.SchemaContext;var anonymousBase="/";var Validator=function Validator(){this.customFormats=Object.create(Validator.prototype.customFormats);this.schemas={};this.unresolvedRefs=[];this.types=Object.create(types);this.attributes=Object.create(attribute.validators)};Validator.prototype.customFormats={};Validator.prototype.schemas=null;Validator.prototype.types=null;Validator.prototype.attributes=null;Validator.prototype.unresolvedRefs=null;Validator.prototype.addSchema=function addSchema(schema,base){var self=this;if(!schema){return null}var scan=scanSchema(base||anonymousBase,schema);var ourUri=base||schema.id;for(var uri in scan.id){this.schemas[uri]=scan.id[uri]}for(var uri in scan.ref){this.unresolvedRefs.push(uri)}this.unresolvedRefs=this.unresolvedRefs.filter(function(uri){return typeof self.schemas[uri]==="undefined"});return this.schemas[ourUri]};Validator.prototype.addSubSchemaArray=function addSubSchemaArray(baseuri,schemas){if(!(schemas instanceof Array))return;for(var i=0;i<schemas.length;i++){this.addSubSchema(baseuri,schemas[i])}};Validator.prototype.addSubSchemaObject=function addSubSchemaArray(baseuri,schemas){if(!schemas||typeof schemas!="object")return;for(var p in schemas){this.addSubSchema(baseuri,schemas[p])}};Validator.prototype.setSchemas=function setSchemas(schemas){this.schemas=schemas};Validator.prototype.getSchema=function getSchema(urn){return this.schemas[urn]};Validator.prototype.validate=function validate(instance,schema,options,ctx){if(!options){options={}}var propertyName=options.propertyName||"instance";var base=urilib.resolve(options.base||anonymousBase,schema.id||"");if(!ctx){ctx=new SchemaContext(schema,options,propertyName,base,Object.create(this.schemas));if(!ctx.schemas[base]){ctx.schemas[base]=schema}var found=scanSchema(base,schema);for(var n in found.id){var sch=found.id[n];ctx.schemas[n]=sch}}if(schema){var result=this.validateSchema(instance,schema,options,ctx);if(!result){throw new Error("Result undefined")}return result}throw new SchemaError("no schema specified",schema)};function shouldResolve(schema){var ref=typeof schema==="string"?schema:schema.$ref;if(typeof ref=="string")return ref;return false}Validator.prototype.validateSchema=function validateSchema(instance,schema,options,ctx){var result=new ValidatorResult(instance,schema,options,ctx);if(typeof schema==="boolean"){if(schema===true){schema={}}else if(schema===false){schema={type:[]}}}else if(!schema){throw new Error("schema is undefined")}if(schema["extends"]){if(schema["extends"]instanceof Array){var schemaobj={schema:schema,ctx:ctx};schema["extends"].forEach(this.schemaTraverser.bind(this,schemaobj));schema=schemaobj.schema;schemaobj.schema=null;schemaobj.ctx=null;schemaobj=null}else{schema=helpers.deepMerge(schema,this.superResolve(schema["extends"],ctx))}}var switchSchema;if(switchSchema=shouldResolve(schema)){var resolved=this.resolve(schema,switchSchema,ctx);var subctx=new SchemaContext(resolved.subschema,options,ctx.propertyPath,resolved.switchSchema,ctx.schemas);return this.validateSchema(instance,resolved.subschema,options,subctx)}var skipAttributes=options&&options.skipAttributes||[];for(var key in schema){if(!attribute.ignoreProperties[key]&&skipAttributes.indexOf(key)<0){var validatorErr=null;var validator=this.attributes[key];if(validator){validatorErr=validator.call(this,instance,schema,options,ctx)}else if(options.allowUnknownAttributes===false){throw new SchemaError("Unsupported attribute: "+key,schema)}if(validatorErr){result.importErrors(validatorErr)}}}if(typeof options.rewrite=="function"){var value=options.rewrite.call(this,instance,schema,options,ctx);result.instance=value}return result};Validator.prototype.schemaTraverser=function schemaTraverser(schemaobj,s){schemaobj.schema=helpers.deepMerge(schemaobj.schema,this.superResolve(s,schemaobj.ctx))};Validator.prototype.superResolve=function superResolve(schema,ctx){var ref;if(ref=shouldResolve(schema)){return this.resolve(schema,ref,ctx).subschema}return schema};Validator.prototype.resolve=function resolve(schema,switchSchema,ctx){switchSchema=ctx.resolve(switchSchema);if(ctx.schemas[switchSchema]){return{subschema:ctx.schemas[switchSchema],switchSchema:switchSchema}}var parsed=urilib.parse(switchSchema);var fragment=parsed&&parsed.hash;var document=fragment&&fragment.length&&switchSchema.substr(0,switchSchema.length-fragment.length);if(!document||!ctx.schemas[document]){throw new SchemaError("no such schema <"+switchSchema+">",schema)}var subschema=helpers.objectGetPath(ctx.schemas[document],fragment.substr(1));if(subschema===undefined){throw new SchemaError("no such schema "+fragment+" located in <"+document+">",schema)}return{subschema:subschema,switchSchema:switchSchema}};Validator.prototype.testType=function validateType(instance,schema,options,ctx,type){if(typeof this.types[type]=="function"){return this.types[type].call(this,instance)}if(type&&typeof type=="object"){var res=this.validateSchema(instance,type,options,ctx);return res===undefined||!(res&&res.errors.length)}return true};var types=Validator.prototype.types={};types.string=function testString(instance){return typeof instance=="string"};types.number=function testNumber(instance){return typeof instance=="number"&&isFinite(instance)};types.integer=function testInteger(instance){return typeof instance=="number"&&instance%1===0};types.boolean=function testBoolean(instance){return typeof instance=="boolean"};types.array=function testArray(instance){return Array.isArray(instance)};types["null"]=function testNull(instance){return instance===null};types.date=function testDate(instance){return instance instanceof Date};types.any=function testAny(instance){return true};types.object=function testObject(instance){return instance&&typeof instance==="object"&&!(instance instanceof Array)&&!(instance instanceof Date)};module.exports=Validator},{"./attribute":1,"./helpers":2,"./scan":4,url:10}],6:[function(require,module,exports){(function(global){(function(root){var freeExports=typeof exports=="object"&&exports&&!exports.nodeType&&exports;var freeModule=typeof module=="object"&&module&&!module.nodeType&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^\x20-\x7E]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw new RangeError(errors[type])}function map(array,fn){var length=array.length;var result=[];while(length--){result[length]=fn(array[length])}return result}function mapDomain(string,fn){var parts=string.split("@");var result="";if(parts.length>1){result=parts[0]+"@";string=parts[1]}string=string.replace(regexSeparators,".");var labels=string.split(".");var encoded=map(labels,fn).join(".");return result+encoded}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.4.1",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define("punycode",function(){return punycode})}else if(freeExports&&freeModule){if(module.exports==freeExports){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],7:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],8:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],9:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":7,"./encode":8}],10:[function(require,module,exports){"use strict";var punycode=require("punycode");var util=require("./util");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=["<",">",'"',"`"," ","\r","\n","\t"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var queryIndex=url.indexOf("?"),splitter=queryIndex!==-1&&queryIndex<url.indexOf("#")?"?":"#",uSplit=url.split(splitter),slashRegex=/\\/g;uSplit[0]=uSplit[0].replace(slashRegex,"/");url=uSplit.join(splitter);var rest=url;rest=rest.trim();if(!slashesDenoteHost&&url.split("#").length===1){var simplePath=simplePathPattern.exec(rest);if(simplePath){this.path=rest;this.href=rest;this.pathname=simplePath[1];if(simplePath[2]){this.search=simplePath[2];if(parseQueryString){this.query=querystring.parse(this.search.substr(1))}else{this.query=this.search.substr(1)}}else if(parseQueryString){this.search="";this.query={}}return this}}var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf("@")}else{atSign=rest.lastIndexOf("@",hostEnd)}if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth)}hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||"";var ipv6Hostname=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}this.hostname=validParts.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!ipv6Hostname){this.hostname=punycode.toASCII(this.hostname)}var p=this.port?":"+this.port:"";var h=this.hostname||"";this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];if(rest.indexOf(ae)===-1)continue;var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query)}rest=rest.slice(0,qm)}else if(parseQueryString){this.search="";this.query={}}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var p=this.pathname||"";var s=this.search||"";this.path=p+s}this.href=this.format();return this};function urlFormat(obj){if(util.isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format()}Url.prototype.format=function(){var auth=this.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=false,query="";if(this.host){host=auth+this.host}else if(this.hostname){host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){host+=":"+this.port}}if(this.query&&util.isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query)}var search=this.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)});search=search.replace("#","%23");return protocol+host+pathname+search+hash};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative)}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format()};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative)}Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url;rel.parse(relative,false,true);relative=rel}var result=new Url;var tkeys=Object.keys(this);for(var tk=0;tk<tkeys.length;tk++){var tkey=tkeys[tk];result[tkey]=this[tkey]}result.hash=relative.hash;if(relative.href===""){result.href=result.format();return result}if(relative.slashes&&!relative.protocol){var rkeys=Object.keys(relative);for(var rk=0;rk<rkeys.length;rk++){var rkey=rkeys[rk];if(rkey!=="protocol")result[rkey]=relative[rkey]}if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname="/"}result.href=result.format();return result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){var keys=Object.keys(relative);for(var v=0;v<keys.length;v++){var k=keys[v];result[k]=relative[k]}result.href=result.format();return result}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");result.pathname=relPath.join("/")}else{result.pathname=relative.pathname}result.search=relative.search;result.query=relative.query;result.host=relative.host||"";result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||"";var s=result.search||"";result.path=p+s}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==="/",isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname="";result.port=null;if(result.host){if(srcPath[0]==="")srcPath[0]=result.host;else srcPath.unshift(result.host)}result.host="";if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}relative.host=null}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){result.host=relative.host||relative.host===""?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===""?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query}else if(!util.isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}result.search=relative.search;result.query=relative.query;if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.href=result.format();return result}if(!srcPath.length){result.pathname=null;if(result.search){result.path="/"+result.search}else{result.path=null}result.href=result.format();return result}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host||srcPath.length>1)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last==="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}if(!srcPath.length){result.pathname=null;result.path=null}else{result.pathname=srcPath.join("/")}if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){this.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)this.hostname=host}},{"./util":11,punycode:6,querystring:9}],11:[function(require,module,exports){"use strict";module.exports={isString:function(arg){return typeof arg==="string"},isObject:function(arg){return typeof arg==="object"&&arg!==null},isNull:function(arg){return arg===null},isNullOrUndefined:function(arg){return arg==null}}},{}],12:[function(require,module,exports){var Template=require("./template");var ParseTree=require("./parsetree");var Validator=require("./validator");var RhsParser=ParseTree.RhsParser;var extend=ParseTree.extend;var Bracery=function(rules,config){extend(this,{rules:{}},config||{});if(rules)this.addRules(rules);return this};Bracery.prototype.defaultSymbol=["origin","sentence"];Bracery.prototype.rng=Math.random;Bracery.prototype.symbolNames=function(){return Object.keys(this.rules).sort()};Bracery.prototype.toJSON=function(){var bracery=this;var result={};var names=arguments.length?Array.prototype.slice.call(arguments,0):bracery.symbolNames();names.forEach(function(name){result[name]=bracery.rules[name].map(function(rhs){return ParseTree.makeRhsText(rhs)})});return result};Bracery.prototype.toText=function(){var bracery=this;var names=arguments.length?Array.prototype.slice.call(arguments,0):bracery.symbolNames();return names.map(function(name){return">"+name+"\n"+bracery.rules[name].map(function(rhs){var text=ParseTree.makeRhsText(rhs);text=text.replace(/\n/g,function(){return"\\n"});if(!text.match(/\S/))text="[|]";else if(text[0]===">")text="\\"+text;return text+"\n"}).join("")+"\n"}).join("")};Bracery.prototype.addRules=function(name,rules){var bracery=this;if(arguments.length===1&&typeof arguments[0]==="object"){var name_rules_map=arguments[0];return Object.keys(name_rules_map).reduce(function(all,name){return extend(all,bracery.addRules(name,name_rules_map[name]))},{})}if(arguments.length!==2||typeof rules==="string")rules=Array.prototype.splice.call(arguments,1);name=validateSymbolName(name);if(!ParseTree.isArray(rules))throw new Error("rules must be an array");if(rules.filter(function(rule){return typeof rule!=="string"}).length)throw new Error("rules array must contain strings");this.rules[name]=(this.rules[name]||[]).concat(rules.map(ParseTree.parseRhs));var result={};result[name]=this.rules[name];return result};Bracery.prototype.getRules=function(name){return this.rules[name]||[]};Bracery.prototype.deleteRules=function(name){var bracery=this;var result;if(arguments.length>1)result=Array.prototype.reduce.call(arguments,function(deleted,name){return extend(deleted,bracery.deleteRules(name))},{});else if(!arguments.length){result=this.rules;this.rules={}}else{name=validateSymbolName(name);result={};result[name]=this.rules[name];delete this.rules[name]}return result};Bracery.prototype.addRule=Bracery.prototype.addRules;Bracery.prototype.deleteRule=Bracery.prototype.deleteRules;Bracery.prototype._expandSymbol=function(config){var symbolName=config.node.name.toLowerCase();var rhs;var rules=this.rules[symbolName];if(rules)rhs=ParseTree.sampleParseTree(ParseTree.randomElement(rules,this.rng),config);else rhs=[];return rhs};Bracery.prototype._expandRhs=function(config){var newConfig=extend({expand:this._expandSymbol.bind(this)},config);if(newConfig.callback)return ParseTree.makeRhsExpansionPromise(newConfig).then(newConfig.callback);return ParseTree.makeRhsExpansionSync(newConfig)};function validateSymbolName(name){if(typeof name!=="string")throw new Error("name must be a string");if(!name.match(/^[A-Za-z_][A-Za-z0-9_]*$/))throw new Error("name must be a valid variable name (alphanumeric/underscore, first char non-numeric)");return name.toLowerCase()}Bracery.prototype.getDefaultSymbol=function(){var bracery=this;if(typeof bracery.defaultSymbol==="string")return bracery.defaultSymbol;for(var n=0;n<bracery.defaultSymbol.length;++n){var name=bracery.defaultSymbol[n];if(bracery.rules[name])return name}return bracery.symbolNames()[0]};Bracery.prototype.expand=function(braceryText,config){braceryText=braceryText||"$"+this.getDefaultSymbol();if(typeof braceryText!=="string")throw new Error("the text to be expanded must be a string");return this._expandRhs(extend({},config,{rhsText:braceryText}))};Bracery.prototype.expandSymbol=function(symbolName,config){symbolName=symbolName||this.getDefaultSymbol();symbolName=validateSymbolName(symbolName);return this._expandRhs(extend({},config,{rhs:[{name:symbolName}]}))};Bracery.prototype.parse=function(text){return ParseTree.makeRoot(ParseTree.parseRhs(text))};Bracery.prototype.unparse=function(root){return ParseTree.makeRhsText([root])};Bracery.prototype.normalize=function(text){return this.unparse(this.parse(text))};module.exports={Bracery:Bracery,ParseTree:ParseTree,RhsParser:RhsParser,Validator:Validator,Template:Template,Promise:Promise,nlp:nlp}},{"./parsetree":13,"./template":16,"./validator":17}],13:[function(require,module,exports){var RhsParser=require("./rhs");var StackTag=".STACK";function isArray(obj){return Object.prototype.toString.call(obj)==="[object Array]"}function extend(dest){dest=dest||{};Array.prototype.slice.call(arguments,1).forEach(function(src){if(src)Object.keys(src).forEach(function(key){dest[key]=src[key]})});return dest}function randomIndex(array,rng){rng=rng||Math.random;return Math.floor(rng()*array.length)}function randomElement(array,rng){return array[randomIndex(array,rng)]}function nRandomElements(array,n,rng){rng=rng||Math.random;var result=[];var index=array.map(function(_dummy,k){return k});for(var i=0;i<n&&i<array.length-1;++i){var j=Math.floor(rng()*(array.length-i))+i;result.push(array[index[j]]);index[j]=index[i]}return result}function parseRhs(rhsText){var result;try{result=RhsParser.parse(rhsText)}catch(e){console.warn("parse error",e);result=[rhsText]}return result}function makeRoot(rhs){return{type:"root",rhs:rhs}}var newSymbolDefReg=/^>([A-Za-z_]\w*)\s*$/;function parseTextDefs(text){var rules={};try{var currentRules,newSymbolDefMatch;text.split(/\n/).forEach(function(line){if(line.length){if(currentRules)currentRules.push(line);else if(newSymbolDefMatch=newSymbolDefReg.exec(line))rules[newSymbolDefMatch[1]]=currentRules=[]}else{currentRules=undefined}})}catch(e){console.log(e)}return rules}var symChar="$",varChar="^",funcChar="&",leftBraceChar="{",rightBraceChar="}",leftSquareBraceChar="[",rightSquareBraceChar="]",assignChar="=",traceryChar="#";function sampleParseTree(rhs,config){var pt=this;var rng=config&&config.rng?config.rng:Math.random;return rhs.map(function(node,n){var result,index;if(typeof node==="string")result=node;else switch(node.type){case"root":result={type:"root",rhs:pt.sampleParseTree(node.rhs,config)};break;case"assign":result={type:"assign",varname:node.varname,value:pt.sampleParseTree(node.value,config),local:node.local?pt.sampleParseTree(node.local,config):undefined};break;case"alt":index=pt.randomIndex(node.opts);result={type:"alt_sampled",n:index,rhs:pt.sampleParseTree(node.opts[index],config)};break;case"alt_sampled":result={type:"alt_sampled",n:node.n,rhs:pt.sampleParseTree(node.rhs,config)};break;case"rep":var n=Math.min(Math.floor(rng()*(node.max+1-node.min))+node.min,config&&config.maxReps?config.maxReps:pt.maxReps);result={type:"rep_sampled",n:n,reps:new Array(n).fill().map(function(){return pt.sampleParseTree(node.unit,config)})};break;case"rep_sampled":result={type:"rep_sampled",n:node.n,reps:node.reps.map(function(rep){return pt.sampleParseTree(rep,config)})};break;case"cond":result={type:"cond",test:node.test,t:pt.sampleParseTree(node.t,config),f:pt.sampleParseTree(node.f,config)};break;case"func":result={type:"func",funcname:node.funcname,args:node.funcname==="quote"?node.args:pt.sampleParseTree(node.args,config)};break;case"lookup":result=node;break;default:case"sym":result={type:"sym"};if(typeof node.name!=="undefined")result.name=node.name;if(typeof node.id!=="undefined")result.id=node.id;break}return result})}function getSymbolNodes(rhs){var pt=this;return rhs.reduce(function(result,node){var r;if(typeof node==="object")switch(node.type){case"lookup":break;case"assign":r=pt.getSymbolNodes((node.value||[]).concat(node.local||[]));break;case"alt":r=node.opts.reduce(function(altResults,opt){return altResults.concat(pt.getSymbolNodes(opt))},[]);break;case"rep":r=pt.getSymbolNodes(node.unit);break;case"func":switch(node.funcname){case"quote":break;case"eval":r=pt.getSymbolNodes(node.args.concat(node.value||[]));break;default:r=pt.getSymbolNodes(node.args);break}break;case"cond":r=pt.getSymbolNodes(node.test.concat(node.t,node.f));break;case"root":case"alt_sampled":r=pt.getSymbolNodes(node.rhs);break;case"rep_sampled":r=pt.getSymbolNodes(node.reps.reduce(function(all,rep){return all.concat(rep)},[]));break;default:case"sym":r=[node];if(node.rhs)r=r.concat(pt.getSymbolNodes(node.rhs));break}return r?result.concat(r):result},[])}function parseTreeEmpty(rhs){var pt=this;return rhs.reduce(function(result,node){if(result){if(typeof node==="string"&&node.match(/\S/))result=false;else{switch(node.type){case"assign":result=pt.parseTreeEmpty(node.value)&&(!node.local||pt.parseTreeEmpty(node.local));break;case"alt":result=node.opts.reduce(function(r,opt){return r&&pt.parseTreeEmpty(opt)},true);break;case"cond":result=pt.parseTreeEmpty(node.t)&&pt.parseTreeEmpty(node.f);break;case"func":result=pt.parseTreeEmpty(node.args);break;case"lookup":result=false;break;case"root":case"alt_sampled":if(node.rhs)result=pt.parseTreeEmpty(node.rhs);break;case"rep_sampled":if(node.reps)return node.reps.reduce(function(all,rep){return all&&pt.parseTreeEmpty(rep)},true);default:case"sym":if(node.rhs)result=pt.parseTreeEmpty(node.rhs);else if(!node.notfound&&!node.limit)result=false;break}}}return result},true)}function isTraceryExpr(node,makeSymbolName){makeSymbolName=makeSymbolName||defaultMakeSymbolName;return typeof node==="object"&&node.type==="cond"&&node.test.length===1&&typeof node.test[0]==="object"&&node.test[0].type==="lookup"&&node.t.length===1&&typeof node.t[0]==="object"&&node.t[0].type==="func"&&node.t[0].funcname==="eval"&&node.t[0].args.length===1&&node.t[0].args[0].type==="lookup"&&node.f.length===1&&typeof node.f[0]==="object"&&node.f[0].type==="sym"&&node.test[0].varname.toLowerCase()===node.t[0].args[0].varname.toLowerCase()&&node.test[0].varname.toLowerCase()===makeSymbolName(node.f[0]).toLowerCase()}function makeFuncArgText(pt,args,makeSymbolName){var noBraces=args.length===1&&(args[0].type==="func"||args[0].type==="lookup"||args[0].type==="alt");return(noBraces?"":leftBraceChar)+pt.makeRhsText(args,makeSymbolName)+(noBraces?"":rightBraceChar)}function makeRhsText(rhs,makeSymbolName){var pt=this;makeSymbolName=makeSymbolName||defaultMakeSymbolName;return rhs.map(function(tok,n){var result;if(typeof tok==="string")result=tok.replace(/[\$&\^\{\}\|\\]/g,function(m){return"\\"+m});else{var nextTok=n<rhs.length-1?rhs[n+1]:undefined;var nextIsAlpha=typeof nextTok==="string"&&nextTok.match(/^[A-Za-z0-9_]/);switch(tok.type){case"root":result=pt.makeRhsText(tok.rhs,makeSymbolName);break;case"lookup":result=nextIsAlpha?varChar+leftBraceChar+tok.varname+rightBraceChar:varChar+tok.varname;break;case"assign":var assign=varChar+tok.varname+assignChar+leftBraceChar+pt.makeRhsText(tok.value,makeSymbolName)+rightBraceChar;if(tok.local)result=funcChar+"let"+assign+leftBraceChar+pt.makeRhsText(tok.local,makeSymbolName)+rightBraceChar;else result=assign;break;case"alt":result=leftSquareBraceChar+tok.opts.map(function(opt){return pt.makeRhsText(opt,makeSymbolName)}).join("|")+rightSquareBraceChar;break;case"rep":result=funcChar+"rep"+makeFuncArgText(pt,tok.unit,makeSymbolName)+leftBraceChar+tok.min+(tok.max!==tok.min?","+tok.max:"")+rightBraceChar;break;case"cond":result=isTraceryExpr(tok,makeSymbolName)?traceryChar+tok.test[0].varname+traceryChar:funcChar+[["if",tok.test],["then",tok.t],["else",tok.f]].map(function(keyword_arg){return keyword_arg[0]+leftBraceChar+pt.makeRhsText(keyword_arg[1],makeSymbolName)+rightBraceChar}).join("");break;case"func":var sugaredName=pt.makeSugaredName(tok,makeSymbolName,nextIsAlpha);switch(tok.funcname){case"strip":result=funcChar+tok.funcname+tok.args.map(function(arg){return makeFuncArgText(pt,[arg],makeSymbolName)}).join("");break;case"quote":result=funcChar+tok.funcname+makeFuncArgText(pt,tok.args,makeSymbolName);break;default:if(sugaredName)result=sugaredName;else result=funcChar+tok.funcname+makeFuncArgText(pt,tok.args,makeSymbolName);break}break;case"alt_sampled":case"rep_sampled":break;default:case"sym":result=nextIsAlpha?symChar+leftBraceChar+makeSymbolName(tok)+rightBraceChar:symChar+makeSymbolName(tok);break}}return result}).join("")}function makeSugaredName(funcNode,makeSymbolName,nextIsAlpha){var name,sugaredName,prefixChar;makeSymbolName=makeSymbolName||defaultMakeSymbolName;if(funcNode.args.length===1&&typeof funcNode.args[0]==="object"){if(funcNode.args[0].type==="sym"){name=makeSymbolName(funcNode.args[0]);prefixChar=symChar}else if(funcNode.args[0].type==="lookup"){name=funcNode.args[0].varname;prefixChar=varChar}if(name){name=name.toLowerCase();var lChar=nextIsAlpha?leftBraceChar:"";var rChar=nextIsAlpha?rightBraceChar:"";if(funcNode.funcname==="cap"&&name.match(/[a-z]/))sugaredName=prefixChar+lChar+name.replace(/[a-z]/,function(c){return c.toUpperCase()})+rChar;else if(funcNode.funcname==="uc"&&name.match(/[a-z]/))sugaredName=prefixChar+lChar+name.toUpperCase()+rChar}}return sugaredName}var defaultSummaryLen=64;function summarize(text,summaryLen){summaryLen=summaryLen||defaultSummaryLen;return text.replace(/^\s*/,"").substr(0,summaryLen)}function summarizeExpansion(expansion,summaryLen){return this.summarize(this.makeExpansionText({node:expansion}),summaryLen)}function summarizeRhs(rhs,makeSymbolName,summaryLen){return this.summarize(this.makeRhsText(rhs,makeSymbolName),summaryLen)}function defaultMakeSymbolName(node){return node.name}function throwExpandError(node){throw new Error("unexpanded symbol node")}function syncPromiseResolve(){var result=Array.prototype.splice.call(arguments,0);if(result.length===1&&result[0]&&typeof result[0].then==="function")return result[0];return{result:result,then:function(next){if(typeof next.then==="function")return next;var nextResult=next.apply(next,result);if(nextResult&&typeof nextResult.then!=="undefined")return nextResult;return syncPromiseResolve(nextResult)},catch:function(errorCallback){}}}function makeSyncResolver(config,callback){return function(){return syncPromiseResolve(callback.apply(config,arguments))}}function makeSyncResolverMap(config,obj){var result={};Object.keys(obj).forEach(function(key){result[key]=makeSyncResolver(config,obj[key])});return result}function makeSyncConfig(config){return extend({},config,{sync:true,before:config.beforeSync?makeSyncResolverMap(config,config.beforeSync):config.before,after:config.afterSync?makeSyncResolverMap(config,config.afterSync):config.after,expand:config.expandSync?makeSyncResolver(config,config.expandSync):config.expand||throwExpandError})}function makeRhsExpansionSync(config){var result;this.makeRhsExpansionPromise(makeSyncConfig(config)).then(function(expansion){result=expansion});return result}function makeExpansionSync(config){var result;this.makeExpansionPromise(makeSyncConfig(config)).then(function(expansion){result=expansion});return result}function makeRhsExpansionPromise(config){var pt=this;var rhs=config.rhs||this.sampleParseTree(parseRhs(config.rhsText),config);var resolve=config.sync?syncPromiseResolve:Promise.resolve.bind(Promise);var maxLength=config.maxLength||pt.maxLength;var maxNodes=config.maxNodes||pt.maxNodes;return rhs.reduce(function(promise,child){return promise.then(function(expansion){if(expansion.text&&expansion.text.length>=maxLength||expansion.nodes&&expansion.nodes>=maxNodes)return expansion;return pt.makeExpansionPromise(extend({},config,{node:child,vars:expansion.vars})).then(function(childExpansion){return extend(expansion,childExpansion,{text:expansion.text+childExpansion.text,tree:expansion.tree.concat(childExpansion.tree),nodes:expansion.nodes+childExpansion.nodes})})})},resolve({text:"",vars:config.vars,tree:[],nodes:0}))}function makeRhsExpansionPromiseForConfig(config,resolve,rhs,contextKey){var pt=this,atLimit=false;var newConfig=extend({},config,{rhs:rhs,depth:extend({},config.depth||{})});var totalDepth=newConfig.totalDepth||0;var maxTotalDepth=Math.min(config.maxDepth||pt.maxDepth);if(totalDepth>=maxTotalDepth)atLimit=true;newConfig.totalDepth=totalDepth+1;if(contextKey&&!atLimit){var recursionDepth=newConfig.depth[contextKey]||0;var maxRecursionDepth=Math.min(config.maxRecursion||pt.maxRecursion);if(recursionDepth>=maxRecursionDepth)atLimit=true;newConfig.depth[contextKey]=recursionDepth+1}if(atLimit)return resolve({text:"",vars:config.vars,nodes:0});return this.makeRhsExpansionPromise(newConfig)}function handlerPromise(args,resolvedPromise,handler){var pt=this;var types=Array.prototype.slice.call(arguments,3);var promise=resolvedPromise;if(handler)types.forEach(function(type){if(handler[type]){promise=promise.then(handler[type].apply(pt,args))}});return promise}function makeExpansionPromise(config){var pt=this;var node=config.node;var varVal=config.vars||{};var depth=config.depth||{};var makeSymbolName=config.makeSymbolName||defaultMakeSymbolName;var resolve=config.sync?syncPromiseResolve:Promise.resolve.bind(Promise);return handlerPromise([node,varVal,depth],resolve(),config.before,node.type,"all").then(function(){var expansion={text:"",vars:varVal,nodes:1};var expansionPromise=resolve(expansion),promise=expansionPromise;var makeRhsExpansionPromiseFor=makeRhsExpansionPromiseForConfig.bind(pt,config,resolve);function addExpansionNodes(x){x.nodes+=expansion.nodes;return extend(expansion,x)}if(node){if(typeof node==="string"){expansion.text=node}else{switch(node.type){case"assign":var name=node.varname.toLowerCase();var oldValue=varVal[name];promise=makeRhsExpansionPromiseFor(node.value).then(function(valExpansion){expansion.vars=valExpansion.vars;expansion.vars[name]=valExpansion.text;expansion.nodes+=valExpansion.nodes;if(node.local){var stack=expansion.vars[StackTag],oldVarStack;if(stack&&stack[name]){oldVarStack=stack[name].slice(0);delete stack[name]}return makeRhsExpansionPromiseForConfig.call(pt,extend({},config,{vars:expansion.vars}),resolve,node.local).then(function(localExpansion){expansion.text=localExpansion.text;expansion.nodes+=localExpansion.nodes;extend(expansion.vars,localExpansion.vars);if(typeof oldValue==="undefined")delete expansion.vars[name];else expansion.vars[name]=oldValue;if(oldVarStack){stack=expansion.vars[StackTag]=expansion.vars[StackTag]||{};stack[name]=oldVarStack}else if(expansion.vars[StackTag])delete expansion.vars[StackTag][name];return expansionPromise})}else return expansionPromise});break;case"lookup":var name=node.varname.toLowerCase();expansion.text=varVal[name]||"";break;case"cond":promise=makeRhsExpansionPromiseFor(node.test).then(function(testExpansion){var testValue=testExpansion.text.match(/\S/)?true:false;var testResult=testValue?node.t:node.f;node.value=testValue;expansion.nodes+=testExpansion.nodes;return makeRhsExpansionPromiseFor(testResult).then(addExpansionNodes)});break;case"func":if(node.funcname==="quote"){expansion.text=pt.makeRhsText(node.args,makeSymbolName)}else if(node.funcname==="push"||node.funcname==="unshift"){node.args.forEach(function(arg){if(arg.type==="lookup"){var stack=expansion.vars[StackTag]=expansion.vars[StackTag]||{};var varStack=stack[arg.varname]=stack[arg.varname]||[];var pushVal=expansion.vars[arg.varname];if(node.funcname==="push")varStack.push(pushVal);else varStack.unshift(pushVal)}})}else if(node.funcname==="pop"||node.funcname==="shift"){node.args.forEach(function(arg){if(arg.type==="lookup"){var newVal="";var stack=expansion.vars[StackTag];if(stack){var varStack=stack[arg.varname];if(varStack){newVal=node.funcname==="pop"?varStack.pop():varStack.shift();if(!varStack.length){delete stack[arg.varname];if(!Object.keys(stack).length)delete expansion.vars[StackTag]}}}expansion.vars[arg.varname]=newVal}})}else if(node.funcname==="strip"){promise=makeRhsExpansionPromiseFor([node.args[0]]).then(function(stripArgExpansion){return makeRhsExpansionPromiseFor([node.args[1]]).then(function(sourceArgExpansion){expansion.text=sourceArgExpansion.text.split(stripArgExpansion.text).join("");return expansionPromise})})}else{promise=makeRhsExpansionPromiseFor(node.args).then(function(argExpansion){var arg=argExpansion.text;expansion.nodes+=argExpansion.nodes;switch(node.funcname){case"eval":if(typeof node.evaltext==="undefined"){node.evaltext=arg;node.evaltree=parseRhs(arg);node.value=pt.sampleParseTree(node.evaltree,config)}else if(config.validateEvalText){var storedEvalText=pt.makeRhsText(node.evaltree,makeSymbolName);if(storedEvalText!==arg){if(config.invalidEvalTextCallback)config.invalidEvalTextCallback(node,storedEvalText,arg);else throw new Error("evaltext mismatch")}}return makeRhsExpansionPromiseFor(node.value,arg).then(addExpansionNodes);break;case"cap":expansion.text=capitalize(arg);break;case"uc":expansion.text=arg.toUpperCase();break;case"lc":expansion.text=arg.toLowerCase();break;case"plural":expansion.text=pluralForm(arg);break;case"a":expansion.text=indefiniteArticle(arg);break;case"nlp_plural":expansion.text=nlp(arg).nouns(0).toPlural().text();break;case"singular":expansion.text=nlp(arg).nouns(0).toSingular().text();break;case"topic":expansion.text=nlp(arg).topics(0).text();break;case"person":expansion.text=nlp(arg).people(0).text();break;case"place":expansion.text=nlp(arg).places(0).text();break;case"past":expansion.text=nlp(arg).verbs(0).toPastTense().text();break;case"present":expansion.text=nlp(arg).verbs(0).toPresentTense().text();break;case"future":expansion.text=nlp(arg).verbs(0).toFutureTense().text();break;case"infinitive":expansion.text=nlp(arg).verbs(0).toInfinitive().text();break;case"gerund":expansion.text=nlp(arg).verbs(0).toGerund().text();break;case"adjective":expansion.text=nlp(arg).verbs(0).asAdjective()[0]||"";break;case"negative":expansion.text=nlp(arg).verbs(0).toNegative().text();break;case"positive":expansion.text=nlp(arg).verbs(0).toPositive().text();break;default:expansion.text=arg;break}}).then(function(){return expansion})}break;case"sym":var symbolExpansionPromise;var expr=symChar+(node.name||node.id);if(!node.rhs&&config.expand)symbolExpansionPromise=handlerPromise([node,varVal,depth],resolve(),config.before,"expand").then(function(){return config.expand(extend({},config,{node:node,vars:varVal}))}).then(function(rhs){node.rhs=rhs;return handlerPromise([node,varVal,depth,rhs],resolve(),config.after,"expand")});else symbolExpansionPromise=resolve();promise=symbolExpansionPromise.then(function(){return makeRhsExpansionPromiseFor(node.rhs||[],expr).then(addExpansionNodes)});break;case"root":case"alt_sampled":promise=makeRhsExpansionPromiseFor(node.rhs||[]).then(addExpansionNodes);break;case"rep_sampled":promise=makeRhsExpansionPromiseFor((node.reps||[]).reduce(function(all,rep){return all.concat(rep)},[])).then(addExpansionNodes);break;default:break}}}return promise}).then(function(expansion){return handlerPromise([node,varVal,depth,expansion],resolve(),config.after,"all",node.type).then(function(){return extend(expansion,{tree:node})})})}function makeRhsExpansionText(config){return this.makeRhsExpansionSync(config).text}function makeExpansionText(config){return this.makeExpansionSync(config).text}function finalVarVal(config){var node=config.node,initVarVal=config.initVarVal;var varVal={};if(initVarVal)extend(varVal,initVarVal);this.makeExpansionText({node:node,vars:varVal,makeSymbolName:config.makeSymbolName});return varVal}var representativePronoun={s1:"i",s2:"you",s3n:"they",s3:"it",p1:"we",p2:"you",p3:"they"};function makeRepresentativePronoun(person,gender){return representativePronoun[person+(gender||"")]||representativePronoun[person]}function conjugate(infinitive,person,gender){var form;var rp=makeRepresentativePronoun(person,gender);switch(infinitive){case"have":form=rp==="it"?"has":"have";break;case"be":form=rp==="i"?"am":rp==="it"?"is":"are";break;case"do":form=rp==="it"?"does":"do";break;case"go":form=rp==="it"?"goes":"go";break;default:form=rp==="it"?infinitive.replace(/.\b/i,function(c){return c+(c==="s"?"es":"s")}):infinitive;break}return form}function was(person,gender){var rp=makeRepresentativePronoun(person,gender);return rp==="i"||rp==="it"?"was":"were"}var irregularPastParticiple={arise:"arisen",babysit:"babysat",be:"been",beat:"beaten",become:"become",bend:"bent",begin:"begun",bet:"bet",bind:"bound",bite:"bitten",bleed:"bled",blow:"blown",break:"broken",breed:"bred",bring:"brought",broadcast:"broadcast",build:"built",buy:"bought",catch:"caught",choose:"chosen",come:"come",cost:"cost",cut:"cut",deal:"dealt",dig:"dug",do:"done",draw:"drawn",drink:"drunk",drive:"driven",eat:"eaten",fall:"fallen",feed:"fed",feel:"felt",fight:"fought",find:"found",fly:"flown",forbid:"forbidden",forget:"forgotten",forgive:"forgiven",freeze:"frozen",get:"gotten",give:"given",go:"gone",grow:"grown",hang:"hung",have:"had",hear:"heard",hide:"hidden",hit:"hit",hold:"held",hurt:"hurt",keep:"kept",know:"known",lay:"laid",lead:"led",leave:"left",lend:"lent",let:"let",lie:"lain",light:"lit",lose:"lost",make:"made",mean:"meant",meet:"met",pay:"paid",put:"put",quit:"quit",read:"read",ride:"ridden",ring:"rung",rise:"risen",run:"run",say:"said",see:"seen",sell:"sold",send:"sent",set:"set",shake:"shaken",shine:"shone",shoot:"shot",show:"shown",shut:"shut",sing:"sung",sink:"sunk",sit:"sat",sleep:"slept",slide:"slid",speak:"spoken",spend:"spent",spin:"spun",spread:"spread",stand:"stood",steal:"stolen",stick:"stuck",sting:"stung",strike:"struck",swear:"sworn",sweep:"swept",swim:"swum",swing:"swung",take:"taken",teach:"taught",tear:"torn",tell:"told",think:"thought",throw:"thrown",understand:"understood",wake:"woken",wear:"worn",win:"won",withdraw:"withdrawn",write:"written"};function pastParticiple(infinitive){return irregularPastParticiple[infinitive]||infinitive.replace(/.\b/i,function(c){return c+(c==="e"?"d":"ed")})}var irregularPastSimple={arise:"arose",babysit:"babysat",be:"was",beat:"beat",become:"became",bend:"bent",begin:"began",bet:"bet",bind:"bound",bite:"bit",bleed:"bled",blow:"blew",break:"broke",breed:"bred",bring:"brought",broadcast:"broadcast",build:"built",buy:"bought",catch:"caught",choose:"chose",come:"came",cost:"cost",cut:"cut",deal:"dealt",dig:"dug",do:"did",draw:"drew",drink:"drank",drive:"drove",eat:"ate",fall:"fell",feed:"fed",feel:"felt",fight:"fought",find:"found",fly:"flew",forbid:"forbade",forget:"forgot",forgive:"forgave",freeze:"froze",get:"got",give:"gave",go:"went",grow:"grew",hang:"hung",have:"had",hear:"heard",hide:"hid",hit:"hit",hold:"held",hurt:"hurt",keep:"kept",know:"knew",lay:"laid",lead:"led",leave:"left",lend:"lent",let:"let",lie:"lay",light:"lit",lose:"lost",make:"made",mean:"meant",meet:"met",pay:"paid",put:"put",quit:"quit",read:"read",ride:"rode",ring:"rang",rise:"rose",run:"ran",say:"said",see:"saw",sell:"sold",send:"sent",set:"set",shake:"shook",shine:"shone",shoot:"shot",show:"showed",shut:"shut",sing:"sang",sink:"sank",sit:"sat",sleep:"slept",slide:"slid",speak:"spoke",spend:"spent",spin:"spun",spread:"spread",stand:"stood",steal:"stole",stick:"stuck",sting:"stung",strike:"struck",swear:"swore",sweep:"swept",swim:"swam",swing:"swung",take:"took",teach:"taught",tear:"tore",tell:"told",think:"thought",throw:"threw",understand:"understood",wake:"woke",wear:"wore",win:"won",withdraw:"withdrew",write:"wrote"};function pastSimple(infinitive){return irregularPastParticiple[infinitive]||infinitive.replace(/.\b/i,function(c){return c+(c==="e"?"d":"ed")})}var genderedNominative={s1:"i",s2:"you",s3m:"he",s3f:"she",s3n:"they",s3i:"it",p1:"we",p2:"you",p3:"they"},genderedOblique={s1:"me",s2:"you",s3m:"him",s3f:"her",s3n:"them",s3i:"it",p1:"us",p2:"you",p3:"them"},genderedPossessiveDeterminer={s1:"my",s2:"your",s3m:"his",s3f:"her",s3n:"their",s3i:"its",p1:"our",p2:"your",p3:"their"},genderedPossessivePronoun={s1:"mine",s2:"yours",s3m:"his",s3f:"hers",s3n:"theirs",s3i:"its",p1:"ours",p2:"yours",p3:"theirs"},genderedReflexive={s1:"myself",s2:"yourself",s3m:"himself",s3f:"herself",s3n:"themself",s3i:"itself",p1:"ourselves",p2:"yourselves",p3:"themselves"};function getPronoun(table,person,gender){return table[person+(gender||"n")]||table[person]}function nominative(person,gender){return getPronoun(genderedNominative,person,gender)}function oblique(person,gender){return getPronoun(genderedOblique,person,gender)}function possessiveDeterminer(person,gender){return getPronoun(genderedPossessiveDeterminer,person,gender)}function possessivePronoun(person,gender){return getPronoun(genderedPossessivePronoun,person,gender)}function reflexive(person,gender){return getPronoun(genderedReflexive,person,gender)}var possessivePronoun={i:"my",you:"your",he:"his",she:"her",they:"their",it:"its",we:"our"};function possessiveApostrophe(noun){var lc=noun.toLowerCase();return possessivePronoun[lc]?possessivePronoun[lc]:noun+(looksLikePlural(noun)?"'":"'s")}function indefiniteArticle(nounPhrase){var article=nounPhrase.match(/^[^A-Za-z]*[aeiou]/i)?"an":"a";return article+" "+nounPhrase}function looksLikePlural(noun){return noun.match(/[b-hj-np-rtv-z][s]$/i)}function lessOrFewer(noun){return(looksLikePlural(noun)?"fewer":"less")+" "+noun}function guessPerson(noun){return looksLikePlural(noun)?"p3":"s3"}function nPlurals(num,singular){if(num===1)return"1 "+singular;return num+" "+this.pluralForm(singular)}var irregularPlural={addendum:"addenda",alga:"algae",alumnus:"alumni",amoeba:"amoebae",antenna:"antennae",bacterium:"bacteria",cactus:"cacti",curriculum:"curricula",datum:"data",fungus:"fungi",genus:"genera",larva:"larvae",memorandum:"memoranda",stimulus:"stimuli",syllabus:"syllabi",vertebra:"vertebrae",echo:"echoes",embargo:"embargoes",hero:"heroes",potato:"potatoes",tomato:"tomatoes",torpedo:"torpedoes",veto:"vetoes",volcano:"volcanoes",child:"children",dormouse:"dormice",foot:"feet",goose:"geese",louse:"lice",man:"men",mouse:"mice",ox:"oxen",tooth:"teeth",woman:"women",axis:"axes",analysis:"analyses",basis:"bases",crisis:"crises",diagnosis:"diagnoses",ellipsis:"ellipses",emphasis:"emphases",hypothesis:"hypotheses",neurosis:"neuroses",oasis:"oases",paralysis:"paralyses",parenthesis:"parentheses",thesis:"theses",appendix:"appendices",index:"indices",matrix:"matrices",barracks:"barracks",deer:"deer",fish:"fish",gallows:"gallows",means:"means",offspring:"offspring",series:"series",sheep:"sheep",species:"species"};function pluralForm(singular){var wm=this;var match;if((match=singular.match(/^([\s\S]*)\b(\w+)(\s*)$/))&&irregularPlural[match[2]])return match[1]+matchCase(match[2],irregularPlural[match[2]])+match[3];else if(singular.match(/(ch|sh|s|x|z)\s*$/i))return singular.replace(/(ch|sh|s|x|z)(\s*)$/i,function(match,ending,spacer){return ending+matchCase(ending,"es")+spacer});else if(singular.match(/[aeiou]y\s*$/i))return singular.replace(/(y)(\s*)$/i,function(match,y,spacer){return matchCase(y,"ys")+spacer});else if(singular.match(/y\s*$/i))return singular.replace(/(y)(\s*)$/i,function(match,y,spacer){return matchCase(y,"ies")+spacer});else if(singular.match(/fe?\s*$/i))return singular.replace(/(fe?)(\s*)$/i,function(match,fe,spacer){return matchCase(fe,"ves")+spacer});else if(singular.match(/o\s*$/i))return singular.replace(/(o)(\s*)$/i,function(match,o,spacer){return matchCase(o,"os")+spacer});else if(singular.match(/[a-zA-Z]\s*$/i))return singular.replace(/([a-zA-Z])(\s*)$/i,function(match,c,spacer){return c+matchCase(c,"s")+spacer});return singular}function matchCase(model,text){return model.match(/[A-Z]/)?text.toUpperCase():text}function countSyllables(word){word=word.toLowerCase();if(word.length<=3)return 1;word=word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/i,"");word=word.replace(/^y/i,"");return word.match(/[aeiouy]{1,2}/gi).length}var irregularComparative={good:"better",well:"better",bad:"worse",far:"farther",little:"less",many:"more"};function makeComparativeAdjective(adj){if(adj.match(/^[a-z]+\b./i))return"more "+adj;var lc=adj.toLowerCase();if(irregularComparative[lc])return irregularComparative[lc];switch(countSyllables(adj)){case 1:return adj.match(/e$/)?adj+"r":adj.match(/ed$/)?"more "+adj:adj+((adj.match(/[b-df-hj-np-tv-z][aeiou][b-df-hj-np-tv-z]$/)?adj.charAt(adj.length-1):"")+"er");case 2:return adj.match(/y$/)?adj.replace(/y$/,"ier"):adj.match(/le$/)?adj+"r":adj.match(/(er|ow)$/)?adj+"er":"more "+adj;default:return"more "+adj}}var adj2adv={public:"publicly"};var adjectivesWithSameAdverb=["early","fast","hard","high","late","near","straight","wrong","well"];adjectivesWithSameAdverb.forEach(function(adj){adj2adv[adj]=adj});function makeAdverb(adjective){if(adj2adv[adjective])return adj2adv[adjective];else if(adjective.match(/ic$/i))return adjective+"ally";else if(adjective.match(/le$/i))return adjective.replace(/e$/i,"y");else if(adjective.match(/y$/i))return adjective.replace(/y$/i,"ily");return adjective+"ly"}function makeComparativeAdverb(adverb){if(adj2adv[adverb]===adverb)return adverb+"er";return"more "+adverb}function capitalize(text){return text.replace(/^([^A-Za-z]*)([a-z])/,function(m,g1,g2){return g1+g2.toUpperCase()}).replace(/([\.\!\?]\s*)([a-z])/g,function(m,g1,g2){return g1+g2.toUpperCase()})}function ordinal(i){var j=i%10,k=i%100;if(j==1&&k!=11){return i+"st"}if(j==2&&k!=12){return i+"nd"}if(j==3&&k!=13){return i+"rd"}return i+"th"}module.exports={maxDepth:100,maxRecursion:3,maxReps:10,maxLength:1e3,maxNodes:1e3,RhsParser:RhsParser,parseRhs:parseRhs,parseTextDefs:parseTextDefs,makeRoot:makeRoot,symChar:symChar,varChar:varChar,funcChar:funcChar,leftBraceChar:leftBraceChar,rightBraceChar:rightBraceChar,leftSquareBraceChar:leftSquareBraceChar,rightSquareBraceChar:rightSquareBraceChar,assignChar:assignChar,traceryChar:traceryChar,sampleParseTree:sampleParseTree,getSymbolNodes:getSymbolNodes,parseTreeEmpty:parseTreeEmpty,isTraceryExpr:isTraceryExpr,makeSugaredName:makeSugaredName,makeRhsText:makeRhsText,makeExpansionText:makeExpansionText,makeRhsExpansionText:makeRhsExpansionText,makeExpansionPromise:makeExpansionPromise,makeRhsExpansionPromise:makeRhsExpansionPromise,makeExpansionSync:makeExpansionSync,makeRhsExpansionSync:makeRhsExpansionSync,summarizeRhs:summarizeRhs,summarizeExpansion:summarizeExpansion,finalVarVal:finalVarVal,conjugate:conjugate,was:was,pastParticiple:pastParticiple,pastSimple:pastSimple,possessiveApostrophe:possessiveApostrophe,indefiniteArticle:indefiniteArticle,lessOrFewer:lessOrFewer,makeComparativeAdjective:makeComparativeAdjective,makeComparativeAdverb:makeComparativeAdverb,makeAdverb:makeAdverb,capitalize:capitalize,countSyllables:countSyllables,pluralForm:pluralForm,ordinal:ordinal,nPlurals:nPlurals,extend:extend,isArray:isArray,randomIndex:randomIndex,randomElement:randomElement,nRandomElements:nRandomElements}},{"./rhs":14}],14:[function(require,module,exports){"use strict";function peg$subclass(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor}function peg$SyntaxError(message,expected,found,location){this.message=message;this.expected=expected;this.found=found;this.location=location;this.name="SyntaxError";if(typeof Error.captureStackTrace==="function"){Error.captureStackTrace(this,peg$SyntaxError)}}peg$subclass(peg$SyntaxError,Error);peg$SyntaxError.buildMessage=function(expected,found){var DESCRIBE_EXPECTATION_FNS={literal:function(expectation){return'"'+literalEscape(expectation.text)+'"'},class:function(expectation){var escapedParts="",i;for(i=0;i<expectation.parts.length;i++){escapedParts+=expectation.parts[i]instanceof Array?classEscape(expectation.parts[i][0])+"-"+classEscape(expectation.parts[i][1]):classEscape(expectation.parts[i])}return"["+(expectation.inverted?"^":"")+escapedParts+"]"},any:function(expectation){return"any character"},end:function(expectation){return"end of input"},other:function(expectation){return expectation.description}};function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}function literalEscape(s){return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return"\\x"+hex(ch)})}function classEscape(s){return s.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return"\\x"+hex(ch)})}function describeExpectation(expectation){return DESCRIBE_EXPECTATION_FNS[expectation.type](expectation)}function describeExpected(expected){var descriptions=new Array(expected.length),i,j;for(i=0;i<expected.length;i++){descriptions[i]=describeExpectation(expected[i])}descriptions.sort();if(descriptions.length>0){for(i=1,j=1;i<descriptions.length;i++){if(descriptions[i-1]!==descriptions[i]){descriptions[j]=descriptions[i];j++}}descriptions.length=j}switch(descriptions.length){case 1:return descriptions[0];case 2:return descriptions[0]+" or "+descriptions[1];default:return descriptions.slice(0,-1).join(", ")+", or "+descriptions[descriptions.length-1]}}function describeFound(found){return found?'"'+literalEscape(found)+'"':"end of input"}return"Expected "+describeExpected(expected)+" but "+describeFound(found)+" found."};function peg$parse(input,options){options=options!==void 0?options:{};var peg$FAILED={},peg$startRuleFunctions={RHS:peg$parseRHS},peg$startRuleFunction=peg$parseRHS,peg$c0="\\n",peg$c1=peg$literalExpectation("\\n",false),peg$c2=function(){return"\n"},peg$c3="\\t",peg$c4=peg$literalExpectation("\\t",false),peg$c5=function(){return"\t"},peg$c6="\\",peg$c7=peg$literalExpectation("\\",false),peg$c8=peg$anyExpectation(),peg$c9=function(escaped){return escaped},peg$c10=/^[^$#&\^{}[\]|\\]/,peg$c11=peg$classExpectation(["$","#","&","^","{","}","[","]","|","\\"],true,false),peg$c12=function(text){return text.join("")},peg$c13=/^[$#&\^]/,peg$c14=peg$classExpectation(["$","#","&","^"],false,false),peg$c15=function(char){return char},peg$c16=function(head,tail){return typeof head==="string"&&tail.length&&typeof tail[0]==="string"?[head+tail[0]].concat(tail.slice(1)):[head].concat(tail)},peg$c17=function(head){return[head]},peg$c18="",peg$c19=function(){return[]},peg$c20="$",peg$c21=peg$literalExpectation("$",false),peg$c22=function(sym){return makeSugaredSymbol(sym)},peg$c23="${",peg$c24=peg$literalExpectation("${",false),peg$c25="}",peg$c26=peg$literalExpectation("}",false),peg$c27="#",peg$c28=peg$literalExpectation("#",false),peg$c29=function(sym,mods){return makeTraceryExpr(sym,mods)},peg$c30=function(mod,mods){return[mod].concat(mods)},peg$c31=".capitalizeAll",peg$c32=peg$literalExpectation(".capitalizeAll",false),peg$c33=function(){return"uc"},peg$c34=".capitalize",peg$c35=peg$literalExpectation(".capitalize",false),peg$c36=function(){return"cap"},peg$c37=".a",peg$c38=peg$literalExpectation(".a",false),peg$c39=function(){return"a"},peg$c40=".ed",peg$c41=peg$literalExpectation(".ed",false),peg$c42=function(){return"past"},peg$c43=".s",peg$c44=peg$literalExpectation(".s",false),peg$c45=function(){return"plural"},peg$c46="&if",peg$c47=peg$literalExpectation("&if",false),peg$c48="then",peg$c49=peg$literalExpectation("then",false),peg$c50="else",peg$c51=peg$literalExpectation("else",false),peg$c52=function(testArg,trueArg,falseArg){return makeConditional(testArg,trueArg,falseArg)},peg$c53="&let",peg$c54=peg$literalExpectation("&let",false),peg$c55=function(assigns,scope){return makeLocalAssignChain(assigns,scope)},peg$c56=function(assigns,sym,mods){return makeLocalAssignChain(assigns,[makeTraceryExpr(sym,mods)])},peg$c57="&",peg$c58=peg$literalExpectation("&",false),peg$c59="push",peg$c60=peg$literalExpectation("push",false),peg$c61="pop",peg$c62=peg$literalExpectation("pop",false),peg$c63="shift",peg$c64=peg$literalExpectation("shift",false),peg$c65="unshift",peg$c66=peg$literalExpectation("unshift",false),peg$c67=function(func,arg){return makeFunction(func,[arg])},peg$c68="{",peg$c69=peg$literalExpectation("{",false),peg$c70=function(func,args){return makeFunction(func,args)},peg$c71=function(head,tail){return[head].concat(tail)},peg$c72="&strip",peg$c73=peg$literalExpectation("&strip",false),peg$c74=function(strip,source){return makeFunction("strip",[wrapNodes(strip),wrapNodes(source)])},peg$c75="eval",peg$c76=peg$literalExpectation("eval",false),peg$c77="quote",peg$c78=peg$literalExpectation("quote",false),peg$c79="plural",peg$c80=peg$literalExpectation("plural",false),peg$c81="singular",peg$c82=peg$literalExpectation("singular",false),peg$c83="nlp_plural",peg$c84=peg$literalExpectation("nlp_plural",false),peg$c85="topic",peg$c86=peg$literalExpectation("topic",false),peg$c87="person",peg$c88=peg$literalExpectation("person",false),peg$c89="place",peg$c90=peg$literalExpectation("place",false),peg$c91="past",peg$c92=peg$literalExpectation("past",false),peg$c93="present",peg$c94=peg$literalExpectation("present",false),peg$c95="future",peg$c96=peg$literalExpectation("future",false),peg$c97="infinitive",peg$c98=peg$literalExpectation("infinitive",false),peg$c99="gerund",peg$c100=peg$literalExpectation("gerund",false),peg$c101="adjective",peg$c102=peg$literalExpectation("adjective",false),peg$c103="negative",peg$c104=peg$literalExpectation("negative",false),peg$c105="positive",peg$c106=peg$literalExpectation("positive",false),peg$c107="a",peg$c108=peg$literalExpectation("a",false),peg$c109="uc",peg$c110=peg$literalExpectation("uc",false),peg$c111="lc",peg$c112=peg$literalExpectation("lc",false),peg$c113="cap",peg$c114=peg$literalExpectation("cap",false),peg$c115=function(rep){return[rep]},peg$c116=function(assign){return[assign]},peg$c117=function(lookup){return[lookup]},peg$c118=function(sym){return[sym]},peg$c119=function(alt){return[alt]},peg$c120=function(func){return[func]},peg$c121=function(args){return args},peg$c122="&rep",peg$c123=peg$literalExpectation("&rep",false),peg$c124=",",peg$c125=peg$literalExpectation(",",false),peg$c126=function(unit,min,max){return validRange(min,max)?makeRep(unit,min,max):text()},peg$c127=function(unit,min){return makeRep(unit,min,min)},peg$c128=/^[0-9]/,peg$c129=peg$classExpectation([["0","9"]],false,false),peg$c130=function(num){return parseInt(num.join(""))},peg$c131="^",peg$c132=peg$literalExpectation("^",false),peg$c133=function(varname){return makeSugaredLookup(varname)},peg$c134="^{",peg$c135=peg$literalExpectation("^{",false),peg$c136="=",peg$c137=peg$literalExpectation("=",false),peg$c138=function(varname,args){return makeAssign(varname,args)},peg$c139="[",peg$c140=peg$literalExpectation("[",false),peg$c141=":",peg$c142=peg$literalExpectation(":",false),peg$c143="]",peg$c144=peg$literalExpectation("]",false),peg$c145="=>",peg$c146=peg$literalExpectation("=>",false),peg$c147=function(varname,opts){return makeAssign(varname,[makeFunction("quote",opts.length===1?opts[0]:[makeAlternation(opts)])])},peg$c148="|",peg$c149=peg$literalExpectation("|",false),peg$c150=function(head,tail){return makeAlternation([head].concat(tail))},peg$c151=/^[A-Z]/,peg$c152=peg$classExpectation([["A","Z"]],false,false),peg$c153=/^[A-Za-z_0-9]/,peg$c154=peg$classExpectation([["A","Z"],["a","z"],"_",["0","9"]],false,false),peg$c155=/^[a-z]/,peg$c156=peg$classExpectation([["a","z"]],false,false),peg$c157=function(firstChar,mid,lc,rest){return firstChar+mid.join("")+lc+rest.join("")},peg$c158=/^[A-Z_0-9]/,peg$c159=peg$classExpectation([["A","Z"],"_",["0","9"]],false,false),peg$c160=function(firstChar,rest){return firstChar+rest.join("")},peg$c161=/^[A-Za-z_]/,peg$c162=peg$classExpectation([["A","Z"],["a","z"],"_"],false,false),peg$c163=peg$otherExpectation("whitespace"),peg$c164=/^[ \t\n\r]/,peg$c165=peg$classExpectation([" ","\t","\n","\r"],false,false),peg$currPos=0,peg$savedPos=0,peg$posDetailsCache=[{line:1,column:1}],peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0,peg$result;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions)){throw new Error("Can't start parsing from rule \""+options.startRule+'".')}peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function text(){return input.substring(peg$savedPos,peg$currPos)}function location(){return peg$computeLocation(peg$savedPos,peg$currPos)}function expected(description,location){location=location!==void 0?location:peg$computeLocation(peg$savedPos,peg$currPos);throw peg$buildStructuredError([peg$otherExpectation(description)],input.substring(peg$savedPos,peg$currPos),location)}function error(message,location){location=location!==void 0?location:peg$computeLocation(peg$savedPos,peg$currPos);throw peg$buildSimpleError(message,location)}function peg$literalExpectation(text,ignoreCase){return{type:"literal",text:text,ignoreCase:ignoreCase}}function peg$classExpectation(parts,inverted,ignoreCase){return{type:"class",parts:parts,inverted:inverted,ignoreCase:ignoreCase}}function peg$anyExpectation(){return{type:"any"}}function peg$endExpectation(){return{type:"end"}}function peg$otherExpectation(description){return{type:"other",description:description}}function peg$computePosDetails(pos){var details=peg$posDetailsCache[pos],p;if(details){return details}else{p=pos-1;while(!peg$posDetailsCache[p]){p--}details=peg$posDetailsCache[p];details={line:details.line,column:details.column};while(p<pos){if(input.charCodeAt(p)===10){details.line++;details.column=1}else{details.column++}p++}peg$posDetailsCache[pos]=details;return details}}function peg$computeLocation(startPos,endPos){var startPosDetails=peg$computePosDetails(startPos),endPosDetails=peg$computePosDetails(endPos);return{start:{offset:startPos,line:startPosDetails.line,column:startPosDetails.column},end:{offset:endPos,line:endPosDetails.line,column:endPosDetails.column}}}function peg$fail(expected){if(peg$currPos<peg$maxFailPos){return}if(peg$currPos>peg$maxFailPos){peg$maxFailPos=peg$currPos;peg$maxFailExpected=[]}peg$maxFailExpected.push(expected)}function peg$buildSimpleError(message,location){return new peg$SyntaxError(message,null,null,location)}function peg$buildStructuredError(expected,found,location){return new peg$SyntaxError(peg$SyntaxError.buildMessage(expected,found),expected,found,location)}function peg$parseRHS(){var s0;s0=peg$parseOuterNodeList();return s0}function peg$parseNode(){var s0,s1,s2;s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c0){s1=peg$c0;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c1)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c2()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c3){s1=peg$c3;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c4)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c5()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===92){s1=peg$c6;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c7)}}if(s1!==peg$FAILED){if(input.length>peg$currPos){s2=input.charAt(peg$currPos);peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c8)}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c9(s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=[];if(peg$c10.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c11)}}if(s2!==peg$FAILED){while(s2!==peg$FAILED){s1.push(s2);if(peg$c10.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c11)}}}}else{s1=peg$FAILED}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c12(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$parseRepetition();if(s0===peg$FAILED){s0=peg$parseSymbol();if(s0===peg$FAILED){s0=peg$parseConditional();if(s0===peg$FAILED){s0=peg$parseLocalAssignment();if(s0===peg$FAILED){s0=peg$parsePushOrPop();if(s0===peg$FAILED){s0=peg$parseStrip();if(s0===peg$FAILED){s0=peg$parseFunction();if(s0===peg$FAILED){s0=peg$parseVarAssignment();if(s0===peg$FAILED){s0=peg$parseVarLookup();if(s0===peg$FAILED){s0=peg$parseAlternation();if(s0===peg$FAILED){s0=peg$currPos;if(peg$c13.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c14)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c15(s1)}s0=s1}}}}}}}}}}}}}}return s0}function peg$parseNodeList(){var s0,s1,s2;s0=peg$currPos;s1=peg$parseNode();if(s1!==peg$FAILED){s2=peg$parseNodeList();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c16(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseNode();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$c18;if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c19()}s0=s1}}return s0}function peg$parseOuterNode(){var s0,s1;s0=peg$parseNode();if(s0===peg$FAILED){s0=peg$currPos;if(input.length>peg$currPos){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c8)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c15(s1)}s0=s1}return s0}function peg$parseOuterNodeList(){var s0,s1,s2;s0=peg$currPos;s1=peg$parseOuterNode();if(s1!==peg$FAILED){s2=peg$parseOuterNodeList();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c16(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseOuterNode();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$c18;if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c19()}s0=s1}}return s0}function peg$parseSymbol(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===36){s1=peg$c20;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c21)}}if(s1!==peg$FAILED){s2=peg$parseIdentifier();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c22(s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c23){s1=peg$c23;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c24)}}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseIdentifier();if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s5=peg$c25;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c22(s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===35){s1=peg$c27;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c28)}}if(s1!==peg$FAILED){s2=peg$parseIdentifier();if(s2!==peg$FAILED){s3=peg$parseTraceryModifiers();if(s3!==peg$FAILED){if(input.charCodeAt(peg$currPos)===35){s4=peg$c27;peg$currPos++}else{s4=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c28)}}if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c29(s2,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}}return s0}function peg$parseTraceryModifiers(){var s0,s1,s2;s0=peg$currPos;s1=peg$parseTraceryModifier();if(s1!==peg$FAILED){s2=peg$parseTraceryModifiers();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c30(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$c18;if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c19()}s0=s1}return s0}function peg$parseTraceryModifier(){var s0,s1;s0=peg$currPos;if(input.substr(peg$currPos,14)===peg$c31){s1=peg$c31;peg$currPos+=14}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c32)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c33()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,11)===peg$c34){s1=peg$c34;peg$currPos+=11}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c35)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c36()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c37){s1=peg$c37;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c38)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c39()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,3)===peg$c40){s1=peg$c40;peg$currPos+=3}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c41)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c42()}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c43){s1=peg$c43;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c44)}}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c45()}s0=s1}}}}return s0}function peg$parseConditional(){var s0,s1,s2,s3,s4,s5,s6;s0=peg$currPos;if(input.substr(peg$currPos,3)===peg$c46){s1=peg$c46;peg$currPos+=3}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c47)}}if(s1!==peg$FAILED){s2=peg$parseFunctionArg();if(s2!==peg$FAILED){if(input.substr(peg$currPos,4)===peg$c48){s3=peg$c48;peg$currPos+=4}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c49)}}if(s3===peg$FAILED){s3=peg$c18}if(s3!==peg$FAILED){s4=peg$parseFunctionArg();if(s4!==peg$FAILED){if(input.substr(peg$currPos,4)===peg$c50){s5=peg$c50;peg$currPos+=4}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c51)}}if(s5===peg$FAILED){s5=peg$c18}if(s5!==peg$FAILED){s6=peg$parseFunctionArg();if(s6!==peg$FAILED){peg$savedPos=s0;s1=peg$c52(s2,s4,s6);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parseLocalAssignment(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;if(input.substr(peg$currPos,4)===peg$c53){s1=peg$c53;peg$currPos+=4}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c54)}}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseVarAssignmentList();if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseFunctionArg();if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c55(s3,s5);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===35){s1=peg$c27;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c28)}}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseVarAssignmentList();if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseIdentifier();if(s5!==peg$FAILED){s6=peg$parseTraceryModifiers();if(s6!==peg$FAILED){if(input.charCodeAt(peg$currPos)===35){s7=peg$c27;peg$currPos++}else{s7=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c28)}}if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c56(s3,s5,s6);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}return s0}function peg$parsePushOrPop(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===38){s1=peg$c57;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c58)}}if(s1!==peg$FAILED){if(input.substr(peg$currPos,4)===peg$c59){s2=peg$c59;peg$currPos+=4}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c60)}}if(s2===peg$FAILED){if(input.substr(peg$currPos,3)===peg$c61){s2=peg$c61;peg$currPos+=3}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c62)}}if(s2===peg$FAILED){if(input.substr(peg$currPos,5)===peg$c63){s2=peg$c63;peg$currPos+=5}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c64)}}if(s2===peg$FAILED){if(input.substr(peg$currPos,7)===peg$c65){s2=peg$c65;peg$currPos+=7}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c66)}}}}}if(s2!==peg$FAILED){s3=peg$parseVarLookup();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c67(s2,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===38){s1=peg$c57;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c58)}}if(s1!==peg$FAILED){if(input.substr(peg$currPos,4)===peg$c59){s2=peg$c59;peg$currPos+=4}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c60)}}if(s2===peg$FAILED){if(input.substr(peg$currPos,3)===peg$c61){s2=peg$c61;peg$currPos+=3}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c62)}}if(s2===peg$FAILED){if(input.substr(peg$currPos,5)===peg$c63){s2=peg$c63;peg$currPos+=5}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c64)}}if(s2===peg$FAILED){if(input.substr(peg$currPos,7)===peg$c65){s2=peg$c65;peg$currPos+=7}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c66)}}}}}if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===123){s3=peg$c68;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c69)}}if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){s5=peg$parseVarLookupList();if(s5!==peg$FAILED){s6=peg$parse_();if(s6!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s7=peg$c25;peg$currPos++}else{s7=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c70(s2,s5);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}return s0}function peg$parseVarLookupList(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseVarLookup();if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseVarLookupList();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c71(s1,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseVarLookup();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1)}s0=s1}return s0}function peg$parseStrip(){var s0,s1,s2,s3;s0=peg$currPos;if(input.substr(peg$currPos,6)===peg$c72){s1=peg$c72;peg$currPos+=6}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c73)}}if(s1!==peg$FAILED){s2=peg$parseFunctionArg();if(s2!==peg$FAILED){s3=peg$parseFunctionArg();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c74(s2,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parseFunction(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===38){s1=peg$c57;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c58)}}if(s1!==peg$FAILED){s2=peg$parseFunctionName();if(s2!==peg$FAILED){s3=peg$parseFunctionArg();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c70(s2,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parseFunctionName(){var s0;if(input.substr(peg$currPos,4)===peg$c75){s0=peg$c75;peg$currPos+=4}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c76)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,5)===peg$c77){s0=peg$c77;peg$currPos+=5}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c78)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,6)===peg$c79){s0=peg$c79;peg$currPos+=6}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c80)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,8)===peg$c81){s0=peg$c81;peg$currPos+=8}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c82)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,10)===peg$c83){s0=peg$c83;peg$currPos+=10}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c84)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,5)===peg$c85){s0=peg$c85;peg$currPos+=5}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c86)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,6)===peg$c87){s0=peg$c87;peg$currPos+=6}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c88)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,5)===peg$c89){s0=peg$c89;peg$currPos+=5}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c90)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,4)===peg$c91){s0=peg$c91;peg$currPos+=4}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c92)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,7)===peg$c93){s0=peg$c93;peg$currPos+=7}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c94)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,6)===peg$c95){s0=peg$c95;peg$currPos+=6}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c96)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,10)===peg$c97){s0=peg$c97;peg$currPos+=10}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c98)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,6)===peg$c99){s0=peg$c99;peg$currPos+=6}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c100)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,9)===peg$c101){s0=peg$c101;peg$currPos+=9}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c102)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,8)===peg$c103){s0=peg$c103;peg$currPos+=8}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c104)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,8)===peg$c105){s0=peg$c105;peg$currPos+=8}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c106)}}if(s0===peg$FAILED){if(input.charCodeAt(peg$currPos)===97){s0=peg$c107;peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c108)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,2)===peg$c109){s0=peg$c109;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c110)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,2)===peg$c111){s0=peg$c111;peg$currPos+=2}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c112)}}if(s0===peg$FAILED){if(input.substr(peg$currPos,3)===peg$c113){s0=peg$c113;peg$currPos+=3}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c114)}}}}}}}}}}}}}}}}}}}}}return s0}function peg$parseFunctionArg(){var s0,s1;s0=peg$currPos;s1=peg$parseRepetition();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c115(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$parseUnit()}return s0}function peg$parseUnit(){var s0,s1;s0=peg$currPos;s1=peg$parseVarAssignment();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c116(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseVarLookup();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c117(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseSymbol();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c118(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseAlternation();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c119(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseFunction();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c120(s1)}s0=s1;if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseDelimitedNodeList();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c121(s1)}s0=s1}}}}}return s0}function peg$parseDelimitedNodeList(){var s0,s1,s2,s3;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===123){s1=peg$c68;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c69)}}if(s1!==peg$FAILED){s2=peg$parseNodeList();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s3=peg$c25;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c121(s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parseRepetition(){var s0,s1,s2,s3,s4,s5,s6,s7;s0=peg$currPos;if(input.substr(peg$currPos,4)===peg$c122){s1=peg$c122;peg$currPos+=4}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c123)}}if(s1!==peg$FAILED){s2=peg$parseUnit();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===123){s3=peg$c68;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c69)}}if(s3!==peg$FAILED){s4=peg$parseNumber();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===44){s5=peg$c124;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c125)}}if(s5!==peg$FAILED){s6=peg$parseNumber();if(s6!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s7=peg$c25;peg$currPos++}else{s7=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s7!==peg$FAILED){peg$savedPos=s0;s1=peg$c126(s2,s4,s6);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,4)===peg$c122){s1=peg$c122;peg$currPos+=4}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c123)}}if(s1!==peg$FAILED){s2=peg$parseUnit();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===123){s3=peg$c68;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c69)}}if(s3!==peg$FAILED){s4=peg$parseNumber();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s5=peg$c25;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c127(s2,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}return s0}function peg$parseNumber(){var s0,s1,s2;s0=peg$currPos;s1=[];if(peg$c128.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c129)}}if(s2!==peg$FAILED){while(s2!==peg$FAILED){s1.push(s2);if(peg$c128.test(input.charAt(peg$currPos))){s2=input.charAt(peg$currPos);peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c129)}}}}else{s1=peg$FAILED}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c130(s1)}s0=s1;return s0}function peg$parseVarLookup(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===94){s1=peg$c131;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c132)}}if(s1!==peg$FAILED){s2=peg$parseIdentifier();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c133(s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.substr(peg$currPos,2)===peg$c134){s1=peg$c134;peg$currPos+=2}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c135)}}if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseIdentifier();if(s3!==peg$FAILED){s4=peg$parse_();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s5=peg$c25;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c133(s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}return s0}function peg$parseVarAssignment(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===94){s1=peg$c131;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c132)}}if(s1!==peg$FAILED){s2=peg$parseIdentifier();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===61){s3=peg$c136;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c137)}}if(s3!==peg$FAILED){s4=peg$parseFunctionArg();if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c138(s2,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===91){s1=peg$c139;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c140)}}if(s1!==peg$FAILED){s2=peg$parseIdentifier();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===58){s3=peg$c141;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c142)}}if(s3!==peg$FAILED){s4=peg$parseNodeList();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===93){s5=peg$c143;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c144)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c138(s2,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===91){s1=peg$c139;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c140)}}if(s1!==peg$FAILED){s2=peg$parseIdentifier();if(s2!==peg$FAILED){if(input.substr(peg$currPos,2)===peg$c145){s3=peg$c145;peg$currPos+=2}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c146)}}if(s3!==peg$FAILED){s4=peg$parseAltList();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===93){s5=peg$c143;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c144)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c147(s2,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}}return s0}function peg$parseVarAssignmentList(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseVarAssignment();if(s1!==peg$FAILED){s2=peg$parse_();if(s2!==peg$FAILED){s3=peg$parseVarAssignmentList();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c71(s1,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseVarAssignment();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1)}s0=s1}return s0}function peg$parseAlternation(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(input.charCodeAt(peg$currPos)===123){s1=peg$c68;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c69)}}if(s1!==peg$FAILED){s2=peg$parseNodeList();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===124){s3=peg$c148;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c149)}}if(s3!==peg$FAILED){s4=peg$parseAltList();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===125){s5=peg$c25;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c150(s2,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;if(input.charCodeAt(peg$currPos)===91){s1=peg$c139;peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c140)}}if(s1!==peg$FAILED){s2=peg$parseNodeList();if(s2!==peg$FAILED){if(input.charCodeAt(peg$currPos)===124){s3=peg$c148;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c149)}}if(s3!==peg$FAILED){s4=peg$parseAltList();if(s4!==peg$FAILED){if(input.charCodeAt(peg$currPos)===93){s5=peg$c143;peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c144)}}if(s5!==peg$FAILED){peg$savedPos=s0;s1=peg$c150(s2,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}return s0}function peg$parseAltList(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseNodeList();if(s1!==peg$FAILED){if(input.charCodeAt(peg$currPos)===124){s2=peg$c148;peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c149)}}if(s2!==peg$FAILED){s3=peg$parseAltList();if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c71(s1,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parseNodeList();if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1)}s0=s1}return s0}function peg$parseCappedIdentifier(){var s0,s1,s2,s3,s4,s5;s0=peg$currPos;if(peg$c151.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c152)}}if(s1!==peg$FAILED){s2=[];if(peg$c153.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c154)}}while(s3!==peg$FAILED){s2.push(s3);if(peg$c153.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c154)}}}if(s2!==peg$FAILED){if(peg$c155.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c156)}}if(s3!==peg$FAILED){s4=[];if(peg$c153.test(input.charAt(peg$currPos))){s5=input.charAt(peg$currPos);peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c154)}}while(s5!==peg$FAILED){s4.push(s5);if(peg$c153.test(input.charAt(peg$currPos))){s5=input.charAt(peg$currPos);peg$currPos++}else{s5=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c154)}}}if(s4!==peg$FAILED){peg$savedPos=s0;s1=peg$c157(s1,s2,s3,s4);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parseUpperCaseIdentifier(){var s0,s1,s2,s3;s0=peg$currPos;if(peg$c151.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c152)}}if(s1!==peg$FAILED){s2=[];if(peg$c158.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c159)}}while(s3!==peg$FAILED){s2.push(s3);if(peg$c158.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c159)}}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c160(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parseIdentifier(){var s0,s1,s2,s3;s0=peg$currPos;if(peg$c161.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c162)}}if(s1!==peg$FAILED){s2=[];if(peg$c153.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c154)}}while(s3!==peg$FAILED){s2.push(s3);if(peg$c153.test(input.charAt(peg$currPos))){s3=input.charAt(peg$currPos);peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c154)}}}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c160(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parse_(){var s0,s1;peg$silentFails++;s0=[];if(peg$c164.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c165)}}while(s1!==peg$FAILED){s0.push(s1);if(peg$c164.test(input.charAt(peg$currPos))){s1=input.charAt(peg$currPos);peg$currPos++}else{s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c165)}}}peg$silentFails--;if(s0===peg$FAILED){s1=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c163)}}return s0}function makeRep(unit,min,max){return{type:"rep",unit:unit,min:min,max:max}}function makeSymbol(name){return{type:"sym",name:name.toLowerCase()}}function makeLookup(name){return{type:"lookup",varname:name}}function makeAssign(name,value){return{type:"assign",varname:name,value:value}}function makeLocalAssign(name,value,scope){return{type:"assign",varname:name,value:value,local:scope}}function makeAlternation(opts){return{type:"alt",opts:opts}}function makeFunction(name,args){return{type:"func",funcname:name,args:args}}function makeConditional(testArg,trueArg,falseArg){return{type:"cond",test:testArg,t:trueArg,f:falseArg}}function wrapNodes(args){return args.length===1?args[0]:{type:"root",rhs:args}}function makeLocalAssignChain(assigns,scope){var list=assigns.slice(0).reverse().reduce(function(chain,assign){return[makeLocalAssign(assign.varname,assign.value,chain)]},scope);return list[0]}function makeCapped(args){return makeFunction("cap",args)}function makeUpperCase(args){return makeFunction("uc",args)}function sugarize(name,makeNode){var node=makeNode(name);if(name.match(/^[0-9_]*[A-Z].*[a-z]/))return makeCapped([node]);else if(name.match(/[A-Z]/)&&!name.match(/[a-z]/))return makeUpperCase([node]);return node}function makeSugaredSymbol(name){return sugarize(name,makeSymbol)}function makeSugaredLookup(name){return sugarize(name,makeLookup)}function makeTraceryExpr(sym,mods){return mods.reduce(function(expr,mod){return makeFunction(mod,[expr])},makeConditional([makeLookup(sym)],[makeFunction("eval",[makeLookup(sym)])],[makeSymbol(sym)]))}function validRange(min,max){return min<=max}peg$result=peg$startRuleFunction();if(peg$result!==peg$FAILED&&peg$currPos===input.length){return peg$result}else{if(peg$result!==peg$FAILED&&peg$currPos<input.length){peg$fail(peg$endExpectation())}throw peg$buildStructuredError(peg$maxFailExpected,peg$maxFailPos<input.length?input.charAt(peg$maxFailPos):null,peg$maxFailPos<input.length?peg$computeLocation(peg$maxFailPos,peg$maxFailPos+1):peg$computeLocation(peg$maxFailPos,peg$maxFailPos))}}module.exports={SyntaxError:peg$SyntaxError,parse:peg$parse}},{}],15:[function(require,module,exports){window.bracery=require("./bracery")},{"./bracery":12}],16:[function(require,module,exports){var ParseTree=require("./parsetree");var extend=ParseTree.extend;var defaultMaxReplies=100;function makeTagArray(text){return text.replace(/^\s*(.*?)\s*$/,function(_m,g){return g}).split(/\s+/).map(function(tag){return tag.toLowerCase()})}function makeTagString(text){return text?" "+makeTagArray(text).join(" ")+" ":""}function parseTemplateDefs(text){var templates=[];try{var newTemplateDefReg=/^(\d*)(@.*?|)(>+)\s*(.*?)\s*(#\s*(.*?)\s*(#\s*(.*?)\s*|)|)$/;var replyChain=[],currentTemplates=[],newTemplateDefMatch;text.split(/\n/).forEach(function(line){if(line.length){if(currentTemplates.length){var parsedLine=ParseTree.parseRhs(line+"\n");currentTemplates.forEach(function(currentTemplate){currentTemplate.content=currentTemplate.content.concat(parsedLine)})}else if(newTemplateDefMatch=newTemplateDefReg.exec(line)){var weight=newTemplateDefMatch[1],author=newTemplateDefMatch[2],depth=newTemplateDefMatch[3].length-1,title=newTemplateDefMatch[4],prevTags=makeTagString(newTemplateDefMatch[6]),tags=makeTagString(newTemplateDefMatch[8]);var isRoot=depth===0&&(!prevTags.match(/\S/)||prevTags.search(" root ")>=0);var authorNames=author?author.substr(1).split(","):[null];currentTemplates=authorNames.map(function(authorName){var currentTemplate={title:title,author:authorName,previousTags:prevTags,tags:tags,isRoot:isRoot,weight:weight.length?parseInt(weight):undefined,content:[],replies:[]};if(depth>replyChain.length)throw new Error("Missing replies in chain");replyChain=replyChain.slice(0,depth);if(depth>0)replyChain[depth-1].replies.push(currentTemplate);else templates.push(currentTemplate);replyChain.push(currentTemplate);return currentTemplate})}}else{currentTemplates=[]}})}catch(e){console.log(e)}return templates}function flattenTemplates(templates,parent){return templates.reduce(function(allTemplates,template){template.parent=parent;return allTemplates.concat(flattenTemplates(template.replies,template))},templates)}function sampleTemplate(templates){var totalWeight=templates.reduce(function(total,template){return total+(template.weight||1)},0);var w=totalWeight*Math.random();for(var i=0;i<templates.length;++i)if((w-=templates[i].weight||1)<=0)return templates[i];return undefined}function randomRootTemplate(templates){return sampleTemplate(templates.filter(function(template){return template.isRoot}))}function randomReplyTemplate(templates,tags,prevTemplate){tags=typeof tags==="string"?makeTagArray(tags):tags;return sampleTemplate(templates.filter(function(template){if(prevTemplate&&prevTemplate.replies.indexOf(template)>=0)return true;var prevTags=template.previousTags.toLowerCase();return tags.reduce(function(match,tag){return match||prevTags.search(" "+tag+" ")>=0},false)}))}function promiseMessageList(config){var bracery=config.bracery,templates=config.templates;var maxReplies=typeof config.maxReplies==="undefined"?defaultMaxReplies:config.maxReplies;var accept=config.accept||function(_expansion,_thread,callback){callback(true)};var prevMessage=config.previousMessage;var generateTemplate=prevMessage?randomReplyTemplate.bind(null,templates,prevMessage.tags,prevMessage.template):randomRootTemplate.bind(null,templates);function generateMessage(){var message;var template=generateTemplate();if(template){var vars=extend({},config.vars||{});message={template:template,vars:extend({},vars),expansion:bracery._expandRhs(extend({},config,{rhs:ParseTree.sampleParseTree(template.content,bracery.rng),vars:vars}))};message.title=vars.title||template.title;message.tags=vars.prevtags=vars.tags||template.tags;delete vars.tags;message.nextVars=extend({},vars)}return message}function promiseMessage(){var proposedMessage=generateMessage();return new Promise(function(resolve,reject){if(!proposedMessage)resolve(true);else accept(proposedMessage,config.thread,resolve)}).then(function(accepted){return accepted?proposedMessage:promiseMessage()})}return promiseMessage().then(function(message){return message?maxReplies>0||typeof maxReplies==="undefined"||maxReplies===null?promiseMessageList(extend({},config,{previousMessage:message,vars:message.nextVars,thread:(config.thread||[]).concat(message),maxReplies:maxReplies?maxReplies-1:maxReplies})).then(function(replies){return[message].concat(replies)}):[message]:[]})}module.exports={parseTemplateDefs:parseTemplateDefs,flattenTemplates:flattenTemplates,sampleTemplate:sampleTemplate,randomRootTemplate:randomRootTemplate,randomReplyTemplate:randomReplyTemplate,promiseMessageList:promiseMessageList,makeTagArray:makeTagArray,makeTagString:makeTagString}},{"./parsetree":13}],17:[function(require,module,exports){var jsonschema=require("jsonschema");var tracerySchema={type:"object",patternProperties:{"^.*$":{oneOf:[{type:"array",items:{type:"string"}},{type:"string"}]}},additionalProperties:false};var wikiMessSchema={type:"array",items:{properties:{name:{type:"string"},rules:{type:"array",items:{type:"array",minItems:1,maxItems:1,items:{type:"string"}}}},required:["name","rules"],additionalProperties:true}};function isTracery(json){return!validateTracery(json).errors.length}function validateTracery(json){var validator=new jsonschema.Validator;var result=validator.validate(json,tracerySchema,{nestedErrors:true});return result}function isWikiMess(json){return!validateWikiMess(json).errors.length}function validateWikiMess(json){var validator=new jsonschema.Validator;var result=validator.validate(json,wikiMessSchema,{nestedErrors:true});return result}module.exports={isTracery:isTracery,validateTracery:validateTracery,isWikiMess:isWikiMess,validateWikiMess:validateWikiMess}},{jsonschema:3}]},{},[15]);
